var re=Object.defineProperty;var le=(b,e,t)=>e in b?re(b,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):b[e]=t;var m=(b,e,t)=>le(b,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&a(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const ce="modulepreload",de=function(b,e){return new URL(b,e).href},se={},oe=function(e,t,a){let s=Promise.resolve();if(t&&t.length>0){let n=function(c){return Promise.all(c.map(d=>Promise.resolve(d).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};const o=document.getElementsByTagName("link"),r=document.querySelector("meta[property=csp-nonce]"),l=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));s=n(t.map(c=>{if(c=de(c,a),c in se)return;se[c]=!0;const d=c.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(!!a)for(let y=o.length-1;y>=0;y--){const p=o[y];if(p.href===c&&(!d||p.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${u}`))return;const f=document.createElement("link");if(f.rel=d?"stylesheet":ce,d||(f.as="script"),f.crossOrigin="",f.href=c,l&&f.setAttribute("nonce",l),document.head.appendChild(f),d)return new Promise((y,p)=>{f.addEventListener("load",y),f.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(n){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=n,window.dispatchEvent(o),!o.defaultPrevented)throw n}return s.then(n=>{for(const o of n||[])o.status==="rejected"&&i(o.reason);return e().catch(i)})},G={},X={debug:0,info:1,warn:2,error:3},he=500,I=[];function ue(){var e;const b=(e=G==null?void 0:G.VITE_LOG_LEVEL)==null?void 0:e.toLowerCase();return b&&b in X?b:"warn"}const ge=ue();function U(b){return X[b]>=X[ge]}function A(b,e){return`[${new Date().toISOString()}] [${b}] ${e}`}function P(b,e,t){const a={timestamp:new Date().toISOString(),level:b,message:e,data:t!==void 0?t:void 0};I.push(a),I.length>he&&I.shift()}const w={debug(b,e){P("debug",b,e),U("debug")&&(e!==void 0?console.info(A("DEBUG",b),e):console.info(A("DEBUG",b)))},info(b,e){P("info",b,e),U("info")&&(e!==void 0?console.info(A("INFO",b),e):console.info(A("INFO",b)))},warn(b,e){P("warn",b,e),U("warn")&&(e!==void 0?console.warn(A("WARN",b),e):console.warn(A("WARN",b)))},error(b,e){P("error",b,e),U("error")&&(e!==void 0?console.error(A("ERROR",b),e):console.error(A("ERROR",b)))},getLogHistory(){return[...I]},clearHistory(){I.length=0}},ae=100,ie=0,K={};class Y{constructor(e={}){m(this,"baseUrl");m(this,"serviceUrls",{});m(this,"token");m(this,"environment");m(this,"customHeaders");m(this,"cache");m(this,"cacheTTL");this.environment=e.environment||"appdev",this.serviceUrls=e.serviceUrls||{},e.apiConfig?(this.baseUrl=e.apiConfig.url,this.customHeaders=e.apiConfig.headers||{}):(this.baseUrl=e.baseUrl||this.serviceUrls.tablescanner||this.getDefaultUrl(this.environment),this.customHeaders=e.headers||{}),this.token=e.token||null,this.cache=new Map,this.cacheTTL=3e5}static isLocalDb(e){return e.startsWith("local:")||e.startsWith("local/")}async getTableSchema(e,t){try{const a=await this.request(`/object/${encodeURIComponent(e)}/tables/${encodeURIComponent(t)}/schema`,"GET",void 0,!0);if(a&&Array.isArray(a.columns))return a.columns;if(Array.isArray(a))return a}catch(a){w.warn("[ApiClient] Schema fetch failed",a)}return[]}getDefaultUrl(e){const t=(K==null?void 0:K.VITE_API_URL)||typeof window<"u"&&window.__API_URL__;if(t)return t;const a={appdev:"https://appdev.kbase.us/services/berdl_table_scanner",prod:"https://kbase.us/services/berdl_table_scanner",local:"http://127.0.0.1:8000"};return a[e]||a.appdev}getHeaders(){const e={"Content-Type":"application/json",Accept:"application/json",...this.customHeaders};if(this.token){const t=this.token.startsWith("Bearer ")?this.token:`Bearer ${this.token}`;e.Authorization=t}else{const t=this.getKBaseSessionCookie();t&&(e.Authorization=`Bearer ${t}`)}return e}getCacheKey(e,t){return`${e}:${JSON.stringify(t||{})}`}getFromCache(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<this.cacheTTL?t.data:null}setCache(e,t){this.cache.set(e,{data:t,timestamp:Date.now()})}clearCache(){this.cache.clear()}setToken(e){this.token=e,this.clearCache()}updateConfig(e){this.baseUrl=e.url,this.customHeaders=e.headers||{},this.clearCache()}setEnvironment(e){this.environment=e,this.baseUrl=this.getDefaultUrl(e),this.clearCache()}async request(e,t,a,s=!1){const i=this.getCacheKey(e,a);if(s&&t==="GET"){const d=this.getFromCache(i);if(d)return d}if(s&&t==="POST"){const d=this.getFromCache(i);if(d)return d}const n=e.startsWith("http")?e:`${this.baseUrl}${e}`,o={method:t,headers:this.getHeaders()};let r=n;if(a)if(t==="GET"){const d=new URL(n);Object.entries(a).forEach(([u,g])=>{g!=null&&d.searchParams.set(u,String(g))}),r=d.toString()}else o.body=JSON.stringify(a);const l=await fetch(r,o);if(!l.ok){let d=`HTTP ${l.status}`,u=null;try{const f=await l.json();u=f,f.detail&&typeof f.detail=="string"&&f.detail.length>0?d=f.detail:d=f.message||f.error||f.msg||d,l.status===500&&f.detail&&f.detail.includes("shock-api")&&(d=f.detail)}catch{d=await l.text().catch(()=>"")||`${d}: ${l.statusText}`}const g=new Error(d);throw g.status=l.status,g.details=u,g}const c=await l.json();return s&&this.setCache(i,c),c}getKBaseSessionCookie(){if(typeof document>"u")return null;try{const e=document.cookie.split("; ").reduce((t,a)=>{const[s,i]=a.split("=");return s&&i&&(t[s.trim()]=i.trim()),t},{});if(e.kbase_session)return w.debug("[ApiClient] Found kbase_session cookie"),e.kbase_session;if(e.kbase_session_backup)return w.debug("[ApiClient] Found kbase_session_backup cookie"),e.kbase_session_backup;w.debug("[ApiClient] No KBase session cookies found")}catch(e){w.warn("[ApiClient] Error parsing cookies",e)}return null}async listTables(e){return this.request(`/object/${encodeURIComponent(e)}/tables`,"GET",void 0,!0)}async testConnection(){try{return await this.request("/health","GET",void 0,!1)}catch{try{return await this.request("/","GET",void 0,!1)}catch(t){throw new Error(`Connection failed: ${t.message}`)}}}async getTableData(e){const t={...e,limit:e.limit||ae,offset:e.offset||ie,kb_env:this.environment};return this.request("/table-data","POST",t,!1)}async getSchema(e){try{return await this.request(`/schema/${encodeURIComponent(e)}/tables`,"GET",void 0,!0)}catch{return null}}async getTableStatistics(e,t){return this.request(`/object/${encodeURIComponent(e)}/tables/${encodeURIComponent(t)}/stats`,"GET",void 0,!0)}async listDatabases(e){return this.request(`/databases?upa=${encodeURIComponent(e)}`,"GET",void 0,!0)}async listTablesInDatabase(e,t){return this.request(`/db/${encodeURIComponent(t)}/tables?upa=${encodeURIComponent(e)}`,"GET",void 0,!0)}async getTableDataFromDatabase(e,t,a){const s=new URLSearchParams({upa:e,limit:String(a.limit||ae),offset:String(a.offset||ie),kb_env:this.environment});a.sort_column&&s.set("sort_column",a.sort_column),a.sort_order&&s.set("sort_order",a.sort_order),a.search_value&&s.set("search",a.search_value);const i=`/db/${encodeURIComponent(t)}/tables/${encodeURIComponent(a.table_name)}/data?${s.toString()}`;return this.request(i,"GET",void 0,!0)}getWorkspaceUrl(){if(this.serviceUrls.workspace)return this.serviceUrls.workspace;const e={appdev:"https://appdev.kbase.us/services/ws",prod:"https://kbase.us/services/ws",local:"https://appdev.kbase.us/services/ws"};return e[this.environment]||e.appdev}async workspaceRpc(e,t){const a=this.getWorkspaceUrl(),s=await fetch(a,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({version:"1.1",method:`Workspace.${e}`,params:t,id:Date.now().toString()})});if(!s.ok)throw new Error(`Workspace RPC failed: ${s.status} ${s.statusText}`);const i=await s.json();if(i.error)throw new Error(i.error.message||"Workspace RPC error");return i.result[0]}async getWorkspaceObject(e){return(await this.workspaceRpc("get_objects2",[{objects:[{ref:e}]}])).data[0].data}async getWorkspaceObjectInfo(e){return this.workspaceRpc("get_object_info3",[{objects:[{ref:e}],includeMetadata:1}])}}class pe{constructor(){m(this,"defaultConfigCache",null);m(this,"kbaseConfigCache",null)}async resolve(e,t={}){if(t.forceDefault){const s=await this.loadDefaultConfig();return s?{config:s,source:"default",sourceDetail:"forced_default",fromCache:!1}:{config:this.createDefaultConfig(e),source:"default",sourceDetail:"minimal_fallback",fromCache:!1}}if(this.kbaseConfigCache)return{config:this.kbaseConfigCache,source:"remote",sourceDetail:"kbase_workspace",fromCache:!0};const a=await this.loadDefaultConfig();return a?{config:a,source:"default",sourceDetail:"default_config",fromCache:!1,warning:`Using default display configuration for "${e}".`}:(w.warn(`[ConfigResolver] No config found for ${e}, using minimal fallback`),{config:this.createDefaultConfig(e),source:"default",sourceDetail:"minimal_fallback",fromCache:!1,warning:`No configuration found for "${e}". Database will be rendered with basic settings.`})}async resolveFromWorkspace(e,t){try{w.debug(`[ConfigResolver] Checking metadata for config: ${e}`);const a=await t.getWorkspaceObjectInfo(e);if(a&&a[0]&&a[0][10]){const s=a[0][10],i=s.kn_config||s.config;if(i)try{const n=JSON.parse(i);return w.info(`[ConfigResolver] Found config in workspace metadata for ${e}`),n}catch(n){w.warn(`[ConfigResolver] Failed to parse config from metadata for ${e}`,n)}}}catch(a){w.warn(`[ConfigResolver] Failed to fetch object info for ${e}`,a)}try{w.debug(`[ConfigResolver] Checking sidecar app-config.json for source: ${e}`);const a=await fetch("./app-config.json").then(i=>i.ok?i.json():null).catch(()=>null),s=a==null?void 0:a.configRef;if(s){w.info(`[ConfigResolver] Found configRef in sidecar: ${s}`);const i=await t.getWorkspaceObject(s);if(i&&i.data)return w.info(`[ConfigResolver] Successfully fetched config object from ${s}`),i.data;w.warn(`[ConfigResolver] Fetched ${s} but got no data`)}else w.debug("[ConfigResolver] No configRef found in sidecar app-config.json");return null}catch(a){return w.warn("[ConfigResolver] Error resolving from workspace (sidecar)",a),null}}setKBaseConfig(e){this.kbaseConfigCache=e,w.info("[ConfigResolver] KBase workspace config loaded")}clearKBaseConfig(){this.kbaseConfigCache=null}hasKBaseConfig(){return this.kbaseConfigCache!==null}async resolveTable(e,t,a={}){var i;return((i=(await this.resolve(e,a)).config.tables)==null?void 0:i[t])??null}createDefaultConfig(e){return{id:this.generateConfigId(e),name:`Auto-generated: ${e}`,version:"1.0.0",description:"Minimal configuration generated from source reference",tables:{}}}generateConfigId(e){return`auto_${e.replace(/[^a-zA-Z0-9]/g,"_")}`}async loadDefaultConfig(){if(this.defaultConfigCache)return this.defaultConfigCache;try{const t=await fetch("./config/tables/default-config.json");if(t.ok){const a=await t.json();return this.defaultConfigCache=a,w.info("[ConfigResolver] Loaded default config"),a}}catch(e){w.warn("[ConfigResolver] Failed to load default config",e)}return null}}let W=null;function me(){return W||(W=new pe),W}const J={pageSize:50,theme:"light",density:"default",showRowNumbers:!0,locale:"en-US",dateFormat:"YYYY-MM-DD",numberFormat:{decimals:2,thousandsSeparator:",",decimalSeparator:"."},defaultSource:"",autoLoad:!1},B={pageSize:50,density:"default",showRowNumbers:!0,enableSelection:!0,enableExport:!0,enableColumnReorder:!1,enableColumnResize:!0,defaultSortColumn:"",defaultSortOrder:"asc"},q={visible:!0,sortable:!0,filterable:!0,searchable:!0},fe={number:"right",integer:"right",float:"right",percentage:"right",currency:"right",filesize:"right",duration:"right",boolean:"center",date:"center",datetime:"center",timestamp:"center"};class be{constructor(e){m(this,"activeConfig",null);m(this,"fallbackConfig",null);m(this,"appConfig",null);m(this,"globalSettings",{...J});m(this,"serviceUrls",{});e&&this.initializeWithAppConfig(e)}initializeWithAppConfig(e){this.appConfig=e,e.defaults&&(this.globalSettings={...J,...e.defaults,numberFormat:{...J.numberFormat,...e.defaults.numberFormat}}),this.serviceUrls={},e.apis&&Object.values(e.apis).forEach(t=>{t.url&&(this.serviceUrls[t.id]=t.url)})}async initialize(e,t){const a=me();try{const s=await a.resolve(e,{forceDefault:!0});s.config&&(this.fallbackConfig=s.config,w.info(`[ConfigManager] Fallback config loaded: ${this.fallbackConfig.id}`))}catch(s){w.error("[ConfigManager] Failed to load fallback config",s)}try{const s=await a.resolveFromWorkspace(e,t);s&&(this.activeConfig=s,w.info(`[ConfigManager] Active config loaded from Workspace: ${this.activeConfig.id}`))}catch(s){w.warn("[ConfigManager] Workspace config retrieval failed, using fallback.",s),this.activeConfig=null}}getConfig(){return this.activeConfig||this.fallbackConfig||null}getTableConfig(e){const t=this.getConfig();if(!t)return null;const a=t.tables[e]||{displayName:e,columns:[],settings:{}};return this.resolveTableConfig(t,e,a)}resolveTableConfig(e,t,a){var o,r,l,c,d,u,g,f,y;const s={...B,pageSize:((o=e.defaults)==null?void 0:o.pageSize)??B.pageSize,density:((r=e.defaults)==null?void 0:r.density)??B.density,showRowNumbers:((l=e.defaults)==null?void 0:l.showRowNumbers)??B.showRowNumbers,...a.settings},i=[...e.sharedCategories||[],...a.categories||[]],n=a.columns.map(p=>this.resolveColumnConfig(p));return{name:t,displayName:a.displayName||t,description:a.description,icon:a.icon,settings:s,categories:i,columns:n,virtualColumns:a.virtualColumns||[],rowConfig:{selectable:((c=a.rowConfig)==null?void 0:c.selectable)??!0,clickable:((d=a.rowConfig)==null?void 0:d.clickable)??!1,clickAction:((u=a.rowConfig)==null?void 0:u.clickAction)??"",heightMode:((g=a.rowConfig)==null?void 0:g.heightMode)??"auto",height:((f=a.rowConfig)==null?void 0:f.height)??"auto",conditionalStyles:((y=a.rowConfig)==null?void 0:y.conditionalStyles)??[]}}}resolveColumnConfig(e){const t=e.dataType||"string",a=fe[t]||"left";return{column:e.column,displayName:e.displayName||e.column.replace(/_/g," "),dataType:t,visible:e.visible??q.visible,sortable:e.sortable??q.sortable,filterable:e.filterable??q.filterable,searchable:e.searchable??q.searchable,copyable:e.copyable??t==="id",width:e.width||"auto",align:e.align||a,categories:e.categories||[],transform:e.transform}}getTableSchema(e){const t=this.getConfig();if(t)return t.tables[e]}hasTableConfig(e){const t=this.getConfig();return!!(t!=null&&t.tables[e])}getTableNames(){const e=this.getConfig();return e?Object.keys(e.tables):[]}getAppName(){var e,t;return((t=(e=this.appConfig)==null?void 0:e.app)==null?void 0:t.name)||"DataTables Viewer"}getServiceUrls(){return this.serviceUrls}getServiceUrl(e){return this.serviceUrls[e]}getGlobalSettings(){return this.globalSettings}getEnvironment(){return"appdev"}}const ne={berdlTableId:null,activeDatabase:null,availableDatabases:[],activeTableName:null,availableTables:[],headers:[],columns:[],visibleColumns:new Set,data:[],totalCount:0,filteredCount:0,currentPage:0,pageSize:50,sortColumn:null,sortDirection:"asc",sortOrder:"asc",columnFilters:{},advancedFilters:void 0,aggregations:void 0,groupBy:void 0,searchQuery:"",searchValue:"",selectedRows:new Set,loading:!1,error:null,theme:"light",density:"normal",showRowNumbers:!0,queryCached:!1,queryTime:void 0};class ye{constructor(e={}){m(this,"state");m(this,"listeners");this.state={...ne,...e},this.listeners=new Set}getState(){return{...this.state}}update(e){e.sortDirection&&!e.sortOrder?e.sortOrder=e.sortDirection:e.sortOrder&&!e.sortDirection&&(e.sortDirection=e.sortOrder),e.searchQuery!==void 0&&e.searchValue===void 0?e.searchValue=e.searchQuery:e.searchValue!==void 0&&e.searchQuery===void 0&&(e.searchQuery=e.searchValue),this.state={...this.state,...e},this.notify()}reset(){this.state={...ne},this.notify()}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(){this.listeners.forEach(e=>e(this.state))}}class ve{constructor(e){m(this,"categories");m(this,"columnsByCategory");m(this,"initialVisibleCategories");m(this,"uncategorizedColumns");this.categories=new Map,this.columnsByCategory=new Map,this.initialVisibleCategories=new Set,this.uncategorizedColumns=new Set,this.initialize(e)}initialize(e){(e.categories||[]).forEach(a=>{this.categories.set(a.id,a),this.columnsByCategory.set(a.id,new Set),a.defaultVisible!==!1&&this.initialVisibleCategories.add(a.id)}),e.columns&&this.setColumns(e.columns)}setColumns(e){this.uncategorizedColumns.clear(),this.categories.forEach((t,a)=>{var s;return(s=this.columnsByCategory.get(a))==null?void 0:s.clear()}),e.forEach(t=>{const a=t.column;let s=!1;t.categories&&Array.isArray(t.categories)&&t.categories.length>0&&t.categories.forEach(i=>{var n;this.categories.has(i)&&((n=this.columnsByCategory.get(i))==null||n.add(a),s=!0)}),s||this.uncategorizedColumns.add(a)})}getInitialVisibleColumns(){const e=new Set;return this.initialVisibleCategories.forEach(t=>{const a=this.columnsByCategory.get(t);a&&a.forEach(s=>e.add(s))}),this.uncategorizedColumns.forEach(t=>e.add(t)),e}getColumnsForCategory(e){return this.columnsByCategory.get(e)||new Set}calculateVisibilityChange(e,t){const a=this.columnsByCategory.get(e);if(!a||a.size===0)return new Set(t);const s=new Set(t),i=Array.from(a);return i.every(o=>t.has(o))?i.forEach(o=>s.delete(o)):i.forEach(o=>s.add(o)),s}getAllCategories(e){return Array.from(this.categories.values()).map(t=>{const a=this.columnsByCategory.get(t.id),s=(a==null?void 0:a.size)||0,i=s>0&&Array.from(a||[]).every(n=>e.has(n));return{...t,visible:i,columnCount:s}})}getColumnsByCategory(){const e=new Map;return this.columnsByCategory.forEach((t,a)=>{e.set(a,Array.from(t))}),e}getUncategorizedColumns(){return Array.from(this.uncategorizedColumns)}}class ee{constructor(e){m(this,"container");m(this,"id");m(this,"dom",{});this.container=e.container,this.id=e.id||`cmp-${Math.random().toString(36).substr(2,9)}`}mount(){this.render(),this.bindEvents()}destroy(){this.container.innerHTML="",this.dom={}}cacheDom(e){this.dom={};for(const[t,a]of Object.entries(e)){const s=this.container.querySelector(a);s&&(this.dom[t]=s)}}}class we extends ee{constructor(t){super(t);m(this,"configManager");m(this,"stateManager");m(this,"categoryManager",null);m(this,"options");m(this,"expandedCategories",new Set);this.configManager=t.configManager,this.stateManager=t.stateManager,this.options=t,this.stateManager.subscribe(a=>{this.dom.loadBtn&&(this.dom.loadBtn.innerHTML=a.loading?'<span class="ts-spinner"></span> Loading...':'<i class="bi bi-lightning-charge-fill"></i> Load Data',this.dom.loadBtn.disabled=a.loading),this.updateLoadingState(a),a.activeTableName&&a.availableTables.length>0&&this.updateTableInfo(a.activeTableName),a.columns.length>0&&this.dom.controlList&&this.renderControlList(),this.renderFilterChips(),this.updateAggregationsDisplay(a)})}get onLoadData(){return this.options.onLoadData}updateAggregationsDisplay(t){var i,n;if(!this.dom.aggregationsSection||!this.dom.aggregationsInfo)return;const a=t.aggregations&&t.aggregations.length>0,s=t.groupBy&&t.groupBy.length>0;if(a||s){this.dom.aggregationsSection.style.display="block";const o=((i=t.aggregations)==null?void 0:i.map(l=>`${l.function.toUpperCase()}(${l.column})`).join(", "))||"None",r=((n=t.groupBy)==null?void 0:n.join(", "))||"None";this.dom.aggregationsInfo.innerHTML=`
                <div style="margin-bottom:4px"><strong>Functions:</strong> ${o}</div>
                <div><strong>Group By:</strong> ${r}</div>
            `}else this.dom.aggregationsSection.style.display="none"}setCategoryManager(t){this.categoryManager=t,this.renderControlList(),this.expandColumnsSection()}expandColumnsSection(){this.dom.controlSection&&(this.dom.controlSection.style.display="block")}collapseColumnsSection(){this.dom.controlSection&&(this.dom.controlSection.style.display="none")}render(){const t=this.configManager.getAppName()||"DataTables Viewer";this.container.innerHTML=`
            <header class="ts-sidebar-header">
                <div class="ts-brand">
                    <div class="ts-brand-icon"><i class="bi bi-grid-3x3-gap-fill"></i></div>
                    <span class="ts-brand-name">${t}</span>
                </div>
            </header>

            <div class="ts-sidebar-body">
            <div class="ts-sidebar-body">

                <!-- Database Selection (for multi-DB objects) -->
                <section class="ts-section" id="ts-db-section" style="display:none; padding: 0 4px;">
                    <div class="ts-section-header">
                        <span class="ts-section-title">Active Database</span>
                    </div>
                    <select class="ts-select" id="ts-database-select"></select>
                </section>

                <!-- Table Selection -->
                <section class="ts-section" id="ts-nav-section" style="display:none; padding: 0 4px;">
                    <div class="ts-section-header">
                        <span class="ts-section-title">Active Table</span>
                    </div>
                    <select class="ts-select" id="ts-table-select"></select>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
                        <button class="ts-btn-secondary" id="ts-view-schema">
                            <i class="bi bi-file-earmark-code"></i> Schema
                        </button>
                        <button class="ts-btn-secondary" id="ts-view-stats">
                            <i class="bi bi-graph-up"></i> Stats
                        </button>
                    </div>
                </section>

                <!-- Data Control (Unified Categories & Columns) -->
                <section class="ts-section" id="ts-control-section" style="display:none; padding: 0 4px;">
                    <div class="ts-section-header">
                        <span class="ts-section-title">Data Control</span>
                        <div class="ts-section-actions">
                            <button class="ts-section-action" id="ts-control-expand-all">Expand All</button>
                            <button class="ts-section-action" id="ts-control-show-all">Show All</button>
                        </div>
                    </div>
                    <div class="ts-control-list" id="ts-control-list"></div>
                </section>

                <!-- Active Filters -->
                <section class="ts-section" id="ts-filters-section" style="display:none; padding: 0 4px;">
                    <div class="ts-section-header">
                        <span class="ts-section-title">Active Filters</span>
                        <div style="display:flex;gap:4px">
                            <button class="ts-section-action" id="ts-advanced-filters" title="Advanced Filters">
                                <i class="bi bi-funnel-fill"></i> Advanced
                            </button>
                            <button class="ts-section-action" id="ts-clear-filters">Clear All</button>
                        </div>
                    </div>
                    <div class="ts-filter-chips" id="ts-filter-chips"></div>
                </section>
                
                <!-- Aggregations -->
                <section class="ts-section" id="ts-aggregations-section" style="display:none; padding: 0 4px;">
                    <div class="ts-section-header">
                        <span class="ts-section-title">Aggregations</span>
                        <button class="ts-section-action" id="ts-aggregations-btn">
                            <i class="bi bi-calculator"></i> Configure
                        </button>
                    </div>
                    <div id="ts-aggregations-info" style="padding:8px;font-size:12px;color:var(--c-text-muted)">
                        No aggregations configured
                    </div>
                </section>
            </div>

            <footer class="ts-sidebar-footer">
                <div class="ts-btn-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button class="ts-btn-secondary" id="ts-export">
                        <i class="bi bi-download"></i> Export
                    </button>
                    <button class="ts-btn-secondary" id="ts-reset">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset
                    </button>
                </div>
            </footer>
        `,this.cacheDom({reset:"#ts-reset",dbSection:"#ts-db-section",databaseSelect:"#ts-database-select",navSection:"#ts-nav-section",tableSelect:"#ts-table-select",viewSchema:"#ts-view-schema",viewStats:"#ts-view-stats",controlSection:"#ts-control-section",controlList:"#ts-control-list",controlExpandAll:"#ts-control-expand-all",controlShowAll:"#ts-control-show-all",filtersSection:"#ts-filters-section",filterChips:"#ts-filter-chips",clearFilters:"#ts-clear-filters",advancedFilters:"#ts-advanced-filters",aggregationsSection:"#ts-aggregations-section",aggregationsBtn:"#ts-aggregations-btn",aggregationsInfo:"#ts-aggregations-info",export:"#ts-export"})}bindEvents(){var t,a,s,i,n,o,r,l;(t=this.dom.databaseSelect)==null||t.addEventListener("change",c=>{const d=c.target.value;this.options.onDatabaseChange&&this.options.onDatabaseChange(d)}),(a=this.dom.tableSelect)==null||a.addEventListener("change",c=>{this.options.onTableChange(c.target.value)}),(s=this.dom.viewSchema)==null||s.addEventListener("click",()=>{const c=this.stateManager.getState();c.activeTableName&&this.options.onShowSchema(c.activeTableName)}),(i=this.dom.viewStats)==null||i.addEventListener("click",()=>{const c=this.stateManager.getState();c.activeTableName&&this.options.onShowStats(c.activeTableName)}),this.dom.controlShowAll&&this.dom.controlShowAll.addEventListener("click",c=>{c.stopPropagation(),this.toggleAllColumns()}),this.dom.controlExpandAll&&this.dom.controlExpandAll.addEventListener("click",c=>{c.stopPropagation(),this.toggleAllCategories()}),(n=this.dom.clearFilters)==null||n.addEventListener("click",()=>{this.stateManager.update({columnFilters:{},advancedFilters:void 0,currentPage:0})}),(o=this.dom.export)==null||o.addEventListener("click",()=>this.options.onExport()),(r=this.dom.reset)==null||r.addEventListener("click",()=>this.options.onReset()),(l=this.dom.controlList)==null||l.addEventListener("click",c=>{const d=c.target;if(d.closest(".ts-switch")){const u=d.closest(".ts-cat-group"),g=u==null?void 0:u.dataset.cat;if(g&&this.categoryManager){const f=this.stateManager.getState().visibleColumns,y=this.categoryManager.calculateVisibilityChange(g,f);this.stateManager.update({visibleColumns:y})}return}if(d.closest(".ts-cat-head")){const u=d.closest(".ts-cat-group"),g=u==null?void 0:u.dataset.cat;g&&(this.expandedCategories.has(g)?this.expandedCategories.delete(g):this.expandedCategories.add(g),u==null||u.classList.toggle("expanded"));return}if(d.matches('input[type="checkbox"]')){const u=d.dataset.col;if(u){const g=this.stateManager.getState();d.checked?g.visibleColumns.add(u):g.visibleColumns.delete(u),this.stateManager.update({visibleColumns:g.visibleColumns})}}}),this.dom.viewSchema&&this.dom.viewSchema.addEventListener("click",()=>{const c=this.stateManager.getState();if(c.activeTableName)this.options.onShowSchema(c.activeTableName);else{const d=this.dom.tableSelect;d!=null&&d.value&&this.options.onShowSchema(d.value)}}),this.dom.viewStats&&this.dom.viewStats.addEventListener("click",()=>{const c=this.stateManager.getState();if(c.activeTableName)this.options.onShowStats(c.activeTableName);else{const d=this.dom.tableSelect;d!=null&&d.value&&this.options.onShowStats(d.value)}}),this.dom.clearFilters&&this.dom.clearFilters.addEventListener("click",()=>{this.stateManager.update({columnFilters:{},advancedFilters:void 0,currentPage:0})}),this.dom.advancedFilters&&this.dom.advancedFilters.addEventListener("click",()=>{this.showAdvancedFilterPanel()}),this.dom.aggregationsBtn&&this.dom.aggregationsBtn.addEventListener("click",()=>{this.showAggregationsPanel()})}showAdvancedFilterPanel(){const t=this.stateManager.getState(),a=t.columns.map(i=>({column:i.column,displayName:i.displayName||i.column,type:i.dataType||"TEXT"})),s=document.createElement("div");s.className="ts-modal-overlay show",s.innerHTML=`
            <div class="ts-modal" style="max-width:600px">
                <div class="ts-modal-header">
                    <h3>Advanced Filters</h3>
                    <button class="ts-modal-close"><i class="bi bi-x"></i></button>
                </div>
                <div class="ts-modal-body" id="ts-advanced-filter-container"></div>
            </div>
        `,document.body.appendChild(s),oe(async()=>{const{AdvancedFilterPanel:i}=await import("./AdvancedFilterPanel-8fPeCncD.js");return{AdvancedFilterPanel:i}},[],import.meta.url).then(({AdvancedFilterPanel:i})=>{var r;const n=s.querySelector("#ts-advanced-filter-container");if(!n)return;const o=new i({container:n,columns:a,onApply:l=>{this.stateManager.update({advancedFilters:l,currentPage:0}),document.body.removeChild(s),this.options.onLoadData()},onCancel:()=>{document.body.removeChild(s)}});t.advancedFilters&&o.setFilters(t.advancedFilters),(r=s.querySelector(".ts-modal-close"))==null||r.addEventListener("click",()=>{document.body.removeChild(s)}),o.mount()})}toggleAllColumns(){const t=this.stateManager.getState();if(t.columns.length===0)return;const a=t.columns.every(i=>t.visibleColumns.has(i.column)),s=new Set;a||t.columns.forEach(i=>s.add(i.column)),this.stateManager.update({visibleColumns:s})}toggleAllCategories(){if(!this.dom.controlList)return;const t=this.dom.controlList.querySelectorAll(".ts-cat-group");if(t.length===0)return;const a=Array.from(t).some(s=>!s.classList.contains("expanded"));t.forEach(s=>{const i=s,n=i.dataset.cat;a?(i.classList.add("expanded"),n&&this.expandedCategories.add(n)):(i.classList.remove("expanded"),n&&this.expandedCategories.delete(n))}),this.dom.controlExpandAll&&(this.dom.controlExpandAll.textContent=a?"Collapse All":"Expand All")}showAggregationsPanel(){var l,c,d,u;const t=this.stateManager.getState(),a=t.columns.map(g=>({column:g.column,displayName:g.displayName||g.column,type:g.dataType||"TEXT"})),s=document.createElement("div");s.className="ts-modal-overlay show",s.innerHTML=`
            <div class="ts-modal" style="max-width:600px">
                <div class="ts-modal-header">
                    <h3>Configure Aggregations</h3>
                    <button class="ts-modal-close"><i class="bi bi-x"></i></button>
                </div>
                <div class="ts-modal-body">
                    <div style="margin-bottom:16px">
                        <label style="display:block;margin-bottom:8px;font-weight:500">Group By Columns</label>
                        <select multiple class="ts-select" id="ts-group-by" style="min-height:100px">
                            ${a.map(g=>`<option value="${g.column}">${g.displayName||g.column}</option>`).join("")}
                        </select>
                        <small style="color:var(--c-text-muted)">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                    <div id="ts-aggregations-list"></div>
                    <button class="ts-btn-secondary" id="ts-add-aggregation" style="margin-top:12px">
                        <i class="bi bi-plus"></i> Add Aggregation
                    </button>
                </div>
                <div class="ts-modal-footer">
                    <button class="ts-btn-secondary" id="ts-agg-cancel">Cancel</button>
                    <button class="ts-btn-primary" id="ts-agg-apply">Apply</button>
                </div>
            </div>
        `,document.body.appendChild(s);const i=t.aggregations||[],n=t.groupBy||[],o=()=>{const g=s.querySelector("#ts-aggregations-list");if(g){if(i.length===0){g.innerHTML='<p style="color:var(--c-text-muted);font-size:13px">No aggregations. Click "Add Aggregation" to create one.</p>';return}g.innerHTML=i.map((f,y)=>`
                <div class="ts-agg-item" style="display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-bottom:8px;padding:12px;background:var(--c-bg-surface-alt);border-radius:var(--radius-sm)">
                    <select class="ts-select" data-agg-col="${y}">
                        ${a.map(p=>`<option value="${p.column}" ${f.column===p.column?"selected":""}>${p.displayName||p.column}</option>`).join("")}
                    </select>
                    <select class="ts-select" data-agg-func="${y}">
                        <option value="count" ${f.function==="count"?"selected":""}>Count</option>
                        <option value="sum" ${f.function==="sum"?"selected":""}>Sum</option>
                        <option value="avg" ${f.function==="avg"?"selected":""}>Average</option>
                        <option value="min" ${f.function==="min"?"selected":""}>Min</option>
                        <option value="max" ${f.function==="max"?"selected":""}>Max</option>
                        <option value="stddev" ${f.function==="stddev"?"selected":""}>StdDev</option>
                        <option value="variance" ${f.function==="variance"?"selected":""}>Variance</option>
                        <option value="distinct_count" ${f.function==="distinct_count"?"selected":""}>Distinct Count</option>
                    </select>
                    <button class="ts-btn-secondary" data-agg-remove="${y}" style="padding:8px">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `).join(""),g.querySelectorAll("[data-agg-col]").forEach(f=>{f.addEventListener("change",y=>{const p=parseInt(y.target.dataset.aggCol||"0");i[p].column=y.target.value})}),g.querySelectorAll("[data-agg-func]").forEach(f=>{f.addEventListener("change",y=>{const p=parseInt(y.target.dataset.aggFunc||"0");i[p].function=y.target.value})}),g.querySelectorAll("[data-agg-remove]").forEach(f=>{f.addEventListener("click",y=>{const p=parseInt(y.target.dataset.aggRemove||"0");i.splice(p,1),o()})})}};(l=s.querySelector("#ts-add-aggregation"))==null||l.addEventListener("click",()=>{var g;i.push({column:((g=a[0])==null?void 0:g.column)||"",function:"count"}),o()}),(c=s.querySelector("#ts-agg-apply"))==null||c.addEventListener("click",()=>{const g=s.querySelector("#ts-group-by"),f=Array.from(g.selectedOptions).map(y=>y.value);this.stateManager.update({aggregations:i.length>0?i:void 0,groupBy:f.length>0?f:void 0,currentPage:0}),document.body.removeChild(s),this.options.onLoadData&&this.options.onLoadData()}),(d=s.querySelector("#ts-agg-cancel"))==null||d.addEventListener("click",()=>{document.body.removeChild(s)}),(u=s.querySelector(".ts-modal-close"))==null||u.addEventListener("click",()=>{document.body.removeChild(s)}),o();const r=s.querySelector("#ts-group-by");n&&Array.from(r.options).forEach(g=>{g.selected=n.includes(g.value)})}updateTables(t){this.dom.navSection&&(t.length>0?(this.dom.navSection.style.display="block",this.dom.tableSelect.innerHTML="",t.forEach(a=>{const s=document.createElement("option");s.value=a.name;const i=a.row_count??a.count,n=typeof i=="number"?i.toLocaleString():"?";s.textContent=`${a.displayName||a.name} (${n} rows)`,this.dom.tableSelect.appendChild(s)})):this.dom.navSection.style.display="none")}updateTableInfo(t){this.dom.tableSelect&&this.dom.tableSelect.value!==t&&(this.dom.tableSelect.value=t)}updateDatabases(t){var a;!this.dom.dbSection||!this.dom.databaseSelect||(t.length>=1?(this.dom.dbSection.style.display="block",this.dom.databaseSelect.innerHTML="",t.forEach(s=>{const i=document.createElement("option");i.value=s.db_name;const n=s.row_count!=null?s.row_count.toLocaleString():"?";i.textContent=s.db_display_name||s.db_name,s.row_count!=null&&(i.textContent+=` (${n} rows)`),this.dom.databaseSelect.appendChild(i)}),this.dom.databaseSelect.disabled=t.length<=1,this.stateManager.update({availableDatabases:t,activeDatabase:((a=t[0])==null?void 0:a.db_name)||null})):this.dom.dbSection.style.display="none")}setActiveDatabase(t){this.dom.databaseSelect&&this.dom.databaseSelect.value!==t&&(this.dom.databaseSelect.value=t)}renderControlList(){if(!this.dom.controlList)return;this.dom.controlSection.style.display="block";const t=this.stateManager.getState(),a=this.categoryManager?this.categoryManager.getAllCategories(t.visibleColumns):[],s=this.categoryManager?this.categoryManager.getColumnsByCategory():new Map,i=this.categoryManager?this.categoryManager.getUncategorizedColumns():t.columns.map(r=>r.column);let n="";a.forEach(r=>{const l=s.get(r.id)||[];l.length!==0&&(n+=this.renderCategoryGroup(r,l,t))}),i.length>0&&(n+=this.renderCategoryGroup({id:"other",name:"Other Attributes",icon:"bi-three-dots",color:"#64748b",visible:!0},i,t,!0)),this.dom.controlList.innerHTML=n;const o=t.columns.length>0&&t.columns.every(r=>t.visibleColumns.has(r.column));if(this.dom.controlShowAll&&(this.dom.controlShowAll.textContent=o?"Hide All":"Show All"),this.dom.controlExpandAll){const r=this.dom.controlList.querySelectorAll(".ts-cat-group"),l=Array.from(r).some(c=>!c.classList.contains("expanded"));this.dom.controlExpandAll.textContent=l?"Expand All":"Collapse All"}}renderCategoryGroup(t,a,s,i=!1){const n=s.columns.reduce((r,l)=>(r[l.column]=l,r),{});return`
            <div class="ts-cat-group ${this.expandedCategories.has(t.id)?"expanded":""}" data-cat="${t.id}">
                <div class="ts-cat-head">
                    <div class="ts-cat-info">
                        <i class="bi bi-chevron-down ts-cat-arrow"></i>
                        <i class="${t.icon||"bi bi-folder-fill"}" style="color:${t.color||"var(--c-accent)"}"></i>
                        <span class="ts-cat-name">${t.name}</span>
                        <span class="ts-cat-count">${a.length}</span>
                    </div>
                    ${i?"":`<div class="ts-switch ${t.visible?"on":""}"></div>`}
                </div>
                <div class="ts-cat-cols">
                    ${a.map(r=>{const l=n[r]||{displayName:r};return`
                            <label class="ts-col-item">
                                <input type="checkbox" data-col="${r}" ${s.visibleColumns.has(r)?"checked":""}>
                                <span>${l.displayName||r}</span>
                            </label>
                        `}).join("")}
                </div>
            </div>
        `}renderFilterChips(){const t=this.stateManager.getState(),a=t.columnFilters,s=t.advancedFilters,i=Object.keys(a).length>0||s&&s.length>0;if(this.dom.filtersSection&&(this.dom.filtersSection.style.display=i?"block":"none"),!this.dom.filterChips)return;const n=[],o=new Set((s||[]).map(r=>r.column));Object.entries(a).forEach(([r,l])=>{o.has(r)||n.push(`
                    <div class="ts-chip">
                        <span class="ts-chip-label">${r}:</span>
                        <span class="ts-chip-value">${l}</span>
                        <button class="ts-chip-clear" data-col="${r}"><i class="bi bi-x"></i></button>
                    </div>
                `)}),s&&s.length>0&&s.forEach((r,l)=>{const c=this.getOperatorLabel(r.operator),d=r.operator==="between"?`${r.value} - ${r.value2}`:r.operator==="in"||r.operator==="not_in"?Array.isArray(r.value)?r.value.join(", "):String(r.value):r.operator==="is_null"||r.operator==="is_not_null"?"":String(r.value||"");n.push(`
                    <div class="ts-chip ts-chip-advanced">
                        <span class="ts-chip-label">${r.column} ${c}:</span>
                        <span class="ts-chip-value">${d}</span>
                        <button class="ts-chip-clear" data-adv-filter="${l}"><i class="bi bi-x"></i></button>
                    </div>
                `)}),this.dom.filterChips.innerHTML=n.join(""),this.dom.filterChips.querySelectorAll(".ts-chip-clear").forEach(r=>{r.addEventListener("click",l=>{var u;const c=l.currentTarget.dataset.col,d=l.currentTarget.dataset.advFilter;if(c){const g={...this.stateManager.getState().columnFilters};delete g[c],this.stateManager.update({columnFilters:g,currentPage:0})}else if(d!==void 0){const g=this.stateManager.getState(),f=(u=g.advancedFilters)==null?void 0:u[parseInt(d)],y=[...g.advancedFilters||[]];y.splice(parseInt(d),1);const p={...g.columnFilters};f!=null&&f.column&&delete p[f.column],this.stateManager.update({columnFilters:p,advancedFilters:y.length>0?y:void 0,currentPage:0})}})})}getOperatorLabel(t){return{eq:"=",ne:"!=",gt:">",gte:">=",lt:"<",lte:"<=",like:"contains",ilike:"contains (i)",in:"in",not_in:"not in",between:"between",is_null:"is null",is_not_null:"is not null",regex:"regex"}[t]||t}getToken(){var t;return((t=this.dom.token)==null?void 0:t.value)||""}setToken(t){this.dom.token&&(this.dom.token.value=t,t&&localStorage.setItem("kbase_token",t))}getBerdlId(){var t;return((t=this.dom.berdl)==null?void 0:t.value)||""}setBerdlId(t){this.dom.berdl&&(this.dom.berdl.value=t)}highlightTokenField(){var t;if(this.dom.token){const a=this.dom.token;a.classList.add("ts-input-required"),a.focus(),a.style.animation="pulse-border 1.5s ease-in-out 2",setTimeout(()=>{a.style.animation=""},3e3)}this.dom.sourceBody&&(this.dom.sourceBody.style.display="block",(t=this.dom.sourceArrow)==null||t.classList.remove("collapsed"))}clearTokenHighlight(){if(this.dom.token){const t=this.dom.token;t.classList.remove("ts-input-required"),t.style.animation=""}}renderCategories(){this.renderControlList()}renderColumnList(){this.renderControlList()}updateLoadingState(t){if(!this.dom.loadingIndicator||!this.dom.loadingText)return;t.loading&&t.availableTables.length===0?(this.dom.loadingIndicator.style.display="block",this.dom.sourceBody&&(this.dom.sourceBody.style.display="block",this.dom.sourceArrow.classList.remove("collapsed")),this.dom.loadingText.textContent="Fetching tables..."):this.dom.loadingIndicator.style.display="none"}}class xe extends ee{constructor(t){super(t);m(this,"options");m(this,"searchTimer");this.options=t}render(){this.container.innerHTML=`
            <div class="ts-search-box">
                <div class="ts-search-input-wrap">
                    <input type="text" id="ts-search" class="ts-search" 
                        placeholder="Highlight matches (doesn't filter rows)..." 
                        aria-label="Highlight matches in table (does not filter rows)">
                    <button class="ts-search-clear" id="ts-search-clear" aria-label="Clear search">
                        <i class="bi bi-x-lg"></i>
                    </button>
                    <i class="bi bi-search ts-search-icon"></i>
                </div>
                <div class="ts-search-nav">
                    <button class="ts-search-nav-btn" id="ts-search-prev" title="Previous match (Shift+Enter)" aria-label="Previous match">
                        <i class="bi bi-chevron-up"></i>
                    </button>
                    <span class="ts-search-nav-info" id="ts-search-info">0/0</span>
                    <button class="ts-search-nav-btn" id="ts-search-next" title="Next match (Enter)" aria-label="Next match">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>
            </div>
            <div class="ts-spacer" style="flex:1"></div>
            <div class="ts-toolbar-actions">
                <button class="ts-tb-btn" id="ts-share" title="Copy shareable link">
                    <i class="bi bi-share"></i> Share
                </button>
                ${this.options.kbaseMode?"":`
                <button class="ts-tb-btn" id="ts-test-connection" title="Test API Connection" style="margin-left: 8px;">
                    <i class="bi bi-lightning-charge"></i> Test Connection
                </button>
                <button class="ts-tb-btn" id="ts-refresh" title="Refresh Data">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                `}
                <button class="ts-tb-icon" id="ts-settings-btn" title="Settings">
                    <i class="bi bi-gear-fill"></i>
                </button>
            </div>
        `,this.cacheDom({search:"#ts-search",searchClear:"#ts-search-clear",searchPrev:"#ts-search-prev",searchNext:"#ts-search-next",searchInfo:"#ts-search-info",share:"#ts-share",testConn:"#ts-test-connection",refresh:"#ts-refresh",settings:"#ts-settings-btn"})}bindEvents(){var t,a,s,i,n,o,r,l;(t=this.dom.search)==null||t.addEventListener("input",()=>{clearTimeout(this.searchTimer);const c=this.dom.search.value;this.updateSearchNav(),this.searchTimer=setTimeout(()=>{this.options.onSearch(c),setTimeout(()=>this.updateSearchNav(),350)},300)}),(a=this.dom.search)==null||a.addEventListener("keydown",c=>{var d,u,g,f;c.key==="Enter"&&!c.shiftKey?(c.preventDefault(),(u=(d=this.options).onSearchNext)==null||u.call(d),this.updateSearchNav()):c.key==="Enter"&&c.shiftKey&&(c.preventDefault(),(f=(g=this.options).onSearchPrev)==null||f.call(g),this.updateSearchNav())}),(s=this.dom.searchClear)==null||s.addEventListener("click",()=>{this.dom.search.value="",this.options.onSearch(""),this.updateSearchNav(),this.dom.search.focus()}),(i=this.dom.searchPrev)==null||i.addEventListener("click",()=>{var c,d;(d=(c=this.options).onSearchPrev)==null||d.call(c),this.updateSearchNav()}),(n=this.dom.searchNext)==null||n.addEventListener("click",()=>{var c,d;(d=(c=this.options).onSearchNext)==null||d.call(c),this.updateSearchNav()}),(o=this.dom.refresh)==null||o.addEventListener("click",()=>this.options.onRefresh()),(r=this.dom.share)==null||r.addEventListener("click",()=>{this.options.onShare&&this.options.onShare()}),(l=this.dom.testConn)==null||l.addEventListener("click",()=>{this.options.onTestConnection&&this.options.onTestConnection()}),setTimeout(()=>this.updateSearchNav(),100)}updateSearchNav(){var i;const t=this.dom.search,a=((i=t==null?void 0:t.value)==null?void 0:i.trim())||"",s=this.container.querySelector(".ts-search-nav");if(s){if(a)s.style.opacity="1",s.style.pointerEvents="auto";else{s.style.opacity="0",s.style.pointerEvents="none";return}if(this.options.getSearchMatchInfo){const n=this.options.getSearchMatchInfo();this.dom.searchInfo&&(n.total>0?(this.dom.searchInfo.textContent=`${n.current}/${n.total}`,this.dom.searchPrev.disabled=!1,this.dom.searchNext.disabled=!1):(this.dom.searchInfo.textContent="0/0",this.dom.searchPrev.disabled=!0,this.dom.searchNext.disabled=!0))}}}getSettingsButton(){return this.dom.settings}setSearch(t){this.dom.search&&(this.dom.search.value=t)}focusSearch(){this.dom.search&&(this.dom.search.focus(),this.dom.search.select())}}const h=class h{static escapeHtml(e){if(e==null)return"";const t=document.createElement("div");return t.textContent=String(e),t.innerHTML}static apply(e,t,a){if(!t)return e!=null?h.escapeHtml(String(e)):"";if(Array.isArray(t))return h.chain(e,{transforms:t},a);const s=t;if(s.condition&&!h.evaluateCondition(s.condition,e,a))return s.fallback?typeof s.fallback=="string"?h.escapeHtml(s.fallback):h.apply(e,s.fallback,a):e!=null?h.escapeHtml(String(e)):"";const i=t.type;if(typeof h[i]=="function")return h[i](e,t.options||{},a);if(h.customTransformers.has(i)){const n=h.customTransformers.get(i);if(n)return n(e,t.options||{},a)}return w.warn(`Unknown transformer type: "${i}"`),e!=null?h.escapeHtml(String(e)):""}static evaluateCondition(e,t,a){const s=e.column?a[e.column]:t,i=e.value;switch(e.operator){case"eq":return s===i;case"neq":return s!==i;case"gt":return Number(s)>Number(i);case"gte":return Number(s)>=Number(i);case"lt":return Number(s)<Number(i);case"lte":return Number(s)<=Number(i);case"contains":return String(s).includes(String(i));case"startsWith":return String(s).startsWith(String(i));case"endsWith":return String(s).endsWith(String(i));case"regex":return new RegExp(String(i)).test(String(s));case"isEmpty":return s==null||s==="";case"isNotEmpty":return s!=null&&s!=="";default:return!0}}static chain(e,t,a){if(!t.transforms||!Array.isArray(t.transforms))return h.escapeHtml(String(e??""));let s=e;for(const i of t.transforms){if(t.transforms.indexOf(i)===t.transforms.length-1)return h.apply(s,i,a);s=h.apply(s,i,a)}return h.escapeHtml(String(s??""))}static number(e,t,a){if(e==null||e==="")return"";const s=Number(e);if(isNaN(s))return h.escapeHtml(String(e));const i=t.decimals??2,n=t.locale||"en-US",o=t.prefix||"",r=t.suffix||"";let l;return t.notation==="scientific"?l=s.toExponential(i):t.notation==="compact"?l=new Intl.NumberFormat(n,{notation:"compact",maximumFractionDigits:i}).format(s):t.notation==="engineering"?l=s.toExponential(i):l=new Intl.NumberFormat(n,{minimumFractionDigits:t.minDecimals??0,maximumFractionDigits:i}).format(s),`<span class="ts-number">${h.escapeHtml(o)}${l}${h.escapeHtml(r)}</span>`}static percentage(e,t,a){if(e==null||e==="")return"";let s=Number(e);if(isNaN(s))return h.escapeHtml(String(e));t.scale100!==!1&&s>=0&&s<=1&&(s*=100);const i=t.decimals??1,n=s.toFixed(i);if(t.showBar){const o=Math.min(100,Math.max(0,s)),r=t.color||"#6366f1";return`
                <div class="ts-percentage">
                    <div class="ts-percentage-bar" style="width:${o}%;background:${r}"></div>
                    <span class="ts-percentage-value">${n}%</span>
                </div>
            `}return`<span class="ts-number">${n}%</span>`}static currency(e,t,a){if(e==null||e==="")return"";const s=Number(e);if(isNaN(s))return h.escapeHtml(String(e));const i=t.locale||"en-US",n=t.currency||"USD";return`<span class="ts-currency">${new Intl.NumberFormat(i,{style:"currency",currency:n,minimumFractionDigits:t.decimals??2,maximumFractionDigits:t.decimals??2}).format(s)}</span>`}static filesize(e,t,a){if(e==null||e==="")return"";const s=Number(e);if(isNaN(s))return h.escapeHtml(String(e));const i=t.binary!==!1,n=i?["B","KiB","MiB","GiB","TiB","PiB"]:["B","KB","MB","GB","TB","PB"],o=i?1024:1e3;let r=s,l=0;for(;r>=o&&l<n.length-1;)r/=o,l++;const c=t.decimals??(l===0?0:2);return`<span class="ts-filesize">${r.toFixed(c)} ${n[l]}</span>`}static duration(e,t,a){if(e==null||e==="")return"";let s=Number(e);if(isNaN(s))return h.escapeHtml(String(e));const i=t.format||"short";if(i==="clock"){const r=Math.floor(s/3600),l=Math.floor(s%3600/60),c=Math.floor(s%60);return r>0?`<span class="ts-duration">${r}:${String(l).padStart(2,"0")}:${String(c).padStart(2,"0")}</span>`:`<span class="ts-duration">${l}:${String(c).padStart(2,"0")}</span>`}const n=[{name:i==="long"?"day":"d",seconds:86400},{name:i==="long"?"hour":"h",seconds:3600},{name:i==="long"?"minute":"m",seconds:60},{name:i==="long"?"second":"s",seconds:1}],o=[];for(const r of n)if(s>=r.seconds){const l=Math.floor(s/r.seconds);s%=r.seconds,i==="long"?o.push(`${l} ${r.name}${l!==1?"s":""}`):o.push(`${l}${r.name}`)}return`<span class="ts-duration">${o.join(i==="long"?", ":" ")||"0s"}</span>`}static date(e,t,a){if(e==null||e==="")return"";const s=new Date(e);if(isNaN(s.getTime()))return h.escapeHtml(String(e));const i=t.locale||"en-US";return t.relative?`<span class="ts-date" title="${s.toISOString()}">${h.relativeTime(s)}</span>`:`<span class="ts-date">${new Intl.DateTimeFormat(i,{dateStyle:t.dateStyle||"medium"}).format(s)}</span>`}static datetime(e,t,a){if(e==null||e==="")return"";const s=new Date(e);if(isNaN(s.getTime()))return h.escapeHtml(String(e));const i=t.locale||"en-US",n=t.timezone||void 0;return`<span class="ts-datetime">${new Intl.DateTimeFormat(i,{dateStyle:t.dateStyle||"medium",timeStyle:t.timeStyle||"short",timeZone:n}).format(s)}</span>`}static relativeTime(e){const a=new Date().getTime()-e.getTime(),s=Math.abs(a/1e3),i=a<0,n=[[31536e3,"year"],[2592e3,"month"],[86400,"day"],[3600,"hour"],[60,"minute"],[1,"second"]];for(const[o,r]of n)if(s>=o){const l=Math.floor(s/o),c=l!==1?"s":"";return i?`in ${l} ${r}${c}`:`${l} ${r}${c} ago`}return"just now"}static boolean(e,t,a){const s=e===!0||e==="true"||e===1||e==="1";if(t.trueIcon||t.falseIcon){const o=s?t.trueIcon||"bi-check-circle-fill":t.falseIcon||"bi-x-circle",r=s?t.trueColor||"#22c55e":t.falseColor||"#ef4444";return`<i class="${o}" style="color:${r};font-size:1.1em"></i>`}const i=s?t.trueText||"Yes":t.falseText||"No";return`<span class="ts-boolean" style="color:${s?t.trueColor||"#22c55e":t.falseColor||"#94a3b8"}">${h.escapeHtml(i)}</span>`}static heatmap(e,t,a){if(e==null||e==="")return"";const s=Number(e);if(isNaN(s))return h.escapeHtml(String(e));const i=t.min??-4,n=t.max??4,o=t.colorScale||"diverging",r=(s-i)/(n-i),l=Math.max(0,Math.min(1,r));let c,d;if(o==="diverging"){let f,y,p;if(l<.5){const v=l*2;f=Math.round(59+196*v),y=Math.round(130+125*v),p=Math.round(246+9*v),d=v<.5?"#fff":"#1e293b"}else{const v=(l-.5)*2;f=Math.round(255+-16*v),y=Math.round(255+-187*v),p=Math.round(255+-187*v),d=v>.5?"#fff":"#1e293b"}c=`rgb(${f}, ${y}, ${p})`}else if(o==="sequential"){const f=Math.round(236+-228*l),y=Math.round(254+-109*l),p=Math.round(255+-77*l);c=`rgb(${f}, ${y}, ${p})`,d=l>.5?"#fff":"#1e293b"}else c="transparent",d="inherit";const u=t.decimals??2,g=t.showValue!==!1?s.toFixed(u):"";return`<span class="ts-heatmap" style="background:${c};color:${d}">${g}</span>`}static progress(e,t,a){if(e==null||e==="")return"";const s=Number(e);if(isNaN(s))return h.escapeHtml(String(e));const i=t.max??100,n=Math.min(100,Math.max(0,s/i*100)),o=t.color||"#6366f1",r=t.showValue!==!1;return`
            <div class="ts-progress">
                <div class="ts-progress-bar" style="width:${n}%;background:${o}"></div>
                ${r?`<span class="ts-progress-value">${s}${t.suffix||""}</span>`:""}
            </div>
        `}static link(e,t,a={}){if(e==null||e==="")return"";const s=String(e),i=encodeURIComponent(s);let n=t.urlTemplate.replace(/\{value\}/g,i);a&&Object.keys(a).length>0&&Object.keys(a).forEach(d=>{const u=`{${d}}`;n.includes(u)&&(n=n.replace(new RegExp(u.replace(/[{}]/g,"\\$&"),"g"),encodeURIComponent(String(a[d]||""))))});let o=s;t.labelTemplate&&(o=t.labelTemplate.replace(/\{value\}/g,s),a&&Object.keys(a).length>0&&Object.keys(a).forEach(d=>{o=o.replace(new RegExp(`\\{${d}\\}`,"g"),String(a[d]||""))}));const r=t.target||"_blank",l=r==="_blank"?' rel="noopener noreferrer"':"",c=t.icon?`<i class="${t.icon}"></i> `:"";return`<a href="${n}" target="${r}"${l} class="ts-cell-link">${c}${h.escapeHtml(o)}</a>`}static replace(e,t){if(e==null||e==="")return"";const a=String(e),s=t.pattern||t.find,i=t.replaceWith||t.replace||"";if(!s)return a;if(t.isRegex)try{const n=t.flags||"g",o=new RegExp(s,n);return a.replace(o,i)}catch(n){return w.error("Invalid regex in replace transformer",n),a}return a.split(s).join(i)}static merge(e,t,a){if(!a||!t.columns||!Array.isArray(t.columns))return"";const s=t.skipEmpty!==!1;if(t.template){let o=t.template;return t.columns.forEach(r=>{const l=a[r],c=`{${r}}`;s&&(l==null||l==="")?(o=o.replace(new RegExp(`\\s*\\(${c}\\)`,"g"),""),o=o.replace(new RegExp(`${c}\\s*[|,;:]\\s*`,"g"),""),o=o.replace(new RegExp(`\\s*[|,;:]\\s*${c}`,"g"),""),o=o.replace(c,"")):o=o.replace(c,String(l||""))}),h.escapeHtml(o.trim())}const i=t.separator||" | ",n=t.columns.map(o=>a[o]).filter(o=>!s||o!=null&&o!=="").map(o=>String(o));return h.escapeHtml(n.join(i))}static badge(e,t,a){if(e==null||e==="")return"";const s=String(e);let o=(t.colorMap||{})[s]||t.color||t.defaultColor;if(!o){const c=["#6366f1","#ef4444","#10b981","#f59e0b","#3b82f6","#8b5cf6","#ec4899","#06b6d4","#84cc16","#f97316"];let d=0;for(let u=0;u<s.length;u++)d=s.charCodeAt(u)+((d<<5)-d);o=c[Math.abs(d)%c.length]}const r=t.variant||"default";let l;return r==="subtle"?l=`background:${o}15;color:${o};border:none`:r==="outline"?l=`background:transparent;color:${o};border:1px solid ${o}`:l=`background:${o}20;color:${o};border:1px solid ${o}40`,`<span class="ts-badge" style="${l}">${h.escapeHtml(s)}</span>`}static array(e,t,a){if(e==null)return"";let s;if(Array.isArray(e))s=e;else if(typeof e=="string"){const l=t.separator||",";s=e.split(l).map(c=>c.trim()).filter(Boolean)}else return h.escapeHtml(String(e));const i=t.limit||5,n=s.slice(0,i),o=s.length-i,r=n.map(l=>h.badge(l,{color:t.color||"#6366f1",variant:"subtle"},a)).join(" ");return o>0?`${r} <span class="ts-badge-more">+${o}</span>`:r}static sequence(e,t){if(!e)return"";let a=String(e);if(t.chunkSize&&t.chunkSize>0){const r=new RegExp(`.{1,${t.chunkSize}}`,"g"),l=a.match(r);l&&(a=l.join(" "))}const s=t.maxLength||30,i=a,n=t.showCopyButton!==!1;a.length>s&&(a=a.substring(0,s)+"...");const o=n?`<button class="ts-copy-btn" data-id="${h.escapeHtml(i)}" title="Copy sequence"><i class="bi bi-clipboard"></i></button>`:"";return`<span class="ts-sequence" title="${h.escapeHtml(i)}">${h.escapeHtml(a)}${o}</span>`}static truncate(e,t){if(!e)return"";const a=String(e),s=t.length||50,i=t.ellipsis??"...";if(a.length<=s)return h.escapeHtml(a);const n=a.substring(0,s)+i;return`<span title="${h.escapeHtml(a)}">${h.escapeHtml(n)}</span>`}static preLoadOntology(e,t="custom"){const a=Date.now();Object.entries(e).forEach(([s,i])=>{const n=`${t}:${s}`;h.ontologyCache.set(n,{name:i,timestamp:a})})}static ontology(e,t,a){if(e==null||e==="")return"";const s=t.delimiter;if(s&&typeof e=="string"&&e.includes(s)){const i=e.split(s).map(o=>o.trim()).filter(Boolean);return i.length===0?"":`<div class="ts-ontology-list" style="display:flex;gap:4px;${t.layout==="vertical"?"flex-direction:column;align-items:flex-start;":"flex-wrap:wrap;"}">
                ${i.map(o=>h.renderSingleOntologyTerm(o,t)).join("")}
            </div>`}return h.renderSingleOntologyTerm(String(e).trim(),t)}static renderSingleOntologyTerm(e,t){if(t.ontologyType){const i=t.ontologyType.toLowerCase();if(i==="uniref"){e=e.replace(/^UniRef:/i,"");const n=e.match(/^(UniRef\d+_\S+)/i);n&&(e=n[1])}else i==="ec"?e=e.replace(/^EC:/i,"").trim():i==="cog"?e=e.replace(/^COG:/i,"").trim():i==="kegg"||i==="ko"?e=e.replace(/^KEGG:/i,"").replace(/^ko:/i,"").trim():i==="uniprot"&&(e=e.replace(/^UniProtKB:/i,"").trim())}const a=`${t.ontologyType||"custom"}:${e}`,s=h.ontologyCache.get(a);return s&&Date.now()-s.timestamp<h.cacheTimeout?h.formatOntologyTerm(e,s.name,{...t,description:s.description}):(h.lookupOntologyTerm(e,t,a),h.formatOntologyTerm(e,null,t))}static lookup(e,t,a){if(e==null||e==="")return"";const s=String(e);if(t.map&&typeof t.map=="object"){const i=t.map[s];if(i!==void 0)return h.escapeHtml(String(i))}if(t.apiUrl){const i=`lookup:${t.apiUrl}:${s}`,n=h.lookupCache.get(i);return n&&Date.now()-n.timestamp<h.cacheTimeout?h.escapeHtml(n.value):(h.performAsyncLookup(s,t,i),h.escapeHtml(s)+' <span class="ts-loading-indicator">...</span>')}return t.fallback?h.escapeHtml(t.fallback):h.escapeHtml(s)}static formatOntologyTerm(e,t,a){const s=a.showId!==!1,i=h.escapeHtml(e),n=a.style||"default";let o="#";a.urlTemplate&&(o=a.urlTemplate.replace(/\{value\}/g,encodeURIComponent(e))),t&&a.urlTemplate&&a.urlTemplate.includes("{name}")&&(o=o.replace(/\{name\}/g,encodeURIComponent(t)));const r=a.urlTemplate?"a":"span",l=a.urlTemplate?` href="${o}" target="_blank" rel="noopener noreferrer"`:"";if(n==="badge"){const c=a.description?` data-description="${h.escapeHtml(a.description)}"`:"",d=i,u=t?h.escapeHtml(t):"";return`
            <div class="ts-ontology-wrapper" style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                <${r}${l} class="ts-badge ts-ontology-badge ${t?"":"ts-loading-term"}" data-term="${i}"${c} style="text-decoration:none;font-family:monospace;flex-shrink:0;">${d}</${r}>
                <span class="ts-ontology-description" data-term-desc="${i}" style="color:var(--c-text-primary);font-size:0.95em;line-height:1.2;">${u}</span>
                ${a.description?`
                <div class="ts-ontology-card">
                    <div class="ts-ontology-card-header">
                        <span class="ts-ontology-card-id">${i}</span>
                        <span class="ts-ontology-card-title">${h.escapeHtml(t||"")}</span>
                    </div>
                    <div class="ts-ontology-card-body" style="color:var(--c-text-primary)">${h.escapeHtml(a.description)}</div>
                    ${a.urlTemplate?`<div class="ts-ontology-card-footer"><a href="${o}" target="_blank" class="ts-link">View Details <i class="bi bi-box-arrow-up-right"></i></a></div>`:""}
                </div>`:""}
            </div>`}if(t){const c=h.escapeHtml(t);return s?`<${r}${l} class="ts-ontology" data-term="${i}">${c} <span class="ts-ontology-id">(${i})</span></${r}>`:`<${r}${l} class="ts-ontology" data-term="${i}">${c}</${r}>`}return`<${r}${l} class="ts-ontology ts-loading-term" data-term="${i}">${i}</${r}>`}static async lookupOntologyTerm(e,t,a){try{let s=null,i;if(t.map&&t.map[e])s=t.map[e];else switch(t.ontologyType){case"GO":{const n=await h.lookupGO(e);n&&(s=n.name,i=n.description);break}case"KEGG":{const n=await h.lookupKEGGEntry(e);n&&(s=n.name,i=n.description);break}case"UniProt":{const n=await h.lookupUniProt(e);n&&(s=n.name,i=n.description);break}case"Pfam":{const n=await h.lookupPfamDomain(e);n&&(s=n.name,i=n.description);break}case"COG":{const n=await h.lookupCOG(e);n&&(s=n.name,i=n.description);break}case"EC":{const n=await h.lookupECNumber(e);n&&(s=n.name,i=n.description);break}case"SO":{const n=await h.lookupSequenceOntology(e);n&&(s=n.name,i=n.description);break}case"UniRef":{const n=await h.lookupUniRef(e);n&&(s=n.name,i=n.description);break}case"custom":t.lookupEndpoint&&(s=await h.lookupCustom(e,t.lookupEndpoint));break}s&&(h.ontologyCache.set(a,{name:s,description:i,timestamp:Date.now()}),h.updateOntologyElements(e,s,{...t,description:i}))}catch(s){w.warn(`Ontology lookup failed for ${e}`,s)}}static updateOntologyElements(e,t,a){document.querySelectorAll(`.ts-ontology-badge[data-term="${e}"]`).forEach(o=>{o.classList.remove("ts-loading-term"),a.description&&o.setAttribute("data-description",a.description)}),document.querySelectorAll(`.ts-ontology-description[data-term-desc="${e}"]`).forEach(o=>{o.textContent=t}),document.querySelectorAll(`.ts-ontology[data-term="${e}"]`).forEach(o=>{o.classList.remove("ts-loading-term"),a.showId!==!1?o.innerHTML=`${h.escapeHtml(t)} <span class="ts-ontology-id">(${h.escapeHtml(e)})</span>`:o.textContent=t}),(a.description||t)&&document.querySelectorAll(".ts-ontology-wrapper").forEach(r=>{if(r.querySelector(`[data-term="${e}"]`)&&!r.querySelector(".ts-ontology-card")){const c=a.urlTemplate?a.urlTemplate.replace(/\{value\}/g,encodeURIComponent(e)):"#",d=`
                        <div class="ts-ontology-card">
                            <div class="ts-ontology-card-header">
                                <span class="ts-ontology-card-id">${h.escapeHtml(e)}</span>
                                <span class="ts-ontology-card-title">${h.escapeHtml(t)}</span>
                            </div>
                            <div class="ts-ontology-card-body" style="color:var(--c-text-primary)">${h.escapeHtml(a.description||t)}</div>
                            ${a.urlTemplate?`<div class="ts-ontology-card-footer"><a href="${c}" target="_blank" class="ts-link">View Details <i class="bi bi-box-arrow-up-right"></i></a></div>`:""}
                        </div>`;r.insertAdjacentHTML("beforeend",d)}})}static async lookupGO(e){var n,o;const t=`https://www.ebi.ac.uk/QuickGO/services/ontology/go/terms/${encodeURIComponent(e)}`,a=await fetch(t,{headers:{Accept:"application/json"}});if(!a.ok)return null;const i=(n=(await a.json()).results)==null?void 0:n[0];return i!=null&&i.name?{name:i.name,description:(o=i.definition)==null?void 0:o.text}:null}static async lookupCustom(e,t){const a=t.replace("{value}",encodeURIComponent(e)),s=await fetch(a);if(!s.ok)return null;const i=await s.json();return i.name||i.label||i.term||null}static async performAsyncLookup(e,t,a){try{const s=t.apiUrl.replace("{value}",encodeURIComponent(e)),i=await fetch(s);if(i.ok){const n=await i.json(),o=t.valuePath?n[t.valuePath]:n.value||n.name||n;o&&h.lookupCache.set(a,{value:String(o),timestamp:Date.now()})}}catch(s){w.error("Async lookup failed",s)}}static conditional(e,t,a){if(!t.conditions||!Array.isArray(t.conditions))return h.escapeHtml(String(e??""));for(const s of t.conditions)if(h.evaluateCondition(s.when,e,a)){if(s.transform)return h.apply(e,s.transform,a);if(s.value!==void 0)return h.escapeHtml(String(s.value))}return t.default?typeof t.default=="object"&&t.default.type?h.apply(e,t.default,a):h.escapeHtml(String(t.default)):h.escapeHtml(String(e??""))}static ontologyLookup(e,t,a){if(e==null||e==="")return"";let s;if(typeof e=="string"){const r=e.trim();if(r.startsWith("["))try{const l=JSON.parse(r);s=Array.isArray(l)?l.filter(Boolean).map(String):[r]}catch{s=[r]}else s=r.split(/[,;]/).map(l=>l.trim()).filter(Boolean)}else Array.isArray(e)?s=e.filter(Boolean).map(String):s=[String(e)];if(s.length===0)return"";const i=s.slice(0,t.limit||5).map(r=>h.renderOntologyLookupTerm(r,t)),n=s.length-(t.limit||5),o=n>0?`<span class="ts-ontology-more" title="${s.slice(t.limit||5).join(", ")}">+${n}</span>`:"";return`<div class="ts-ontology-lookup-list">${i.join("")}${o}</div>`}static renderOntologyLookupTerm(e,t){const a=t.idPattern||"(rxn\\d+|cpd\\d+)",s=e.match(new RegExp(a,"i")),i=s?s[1]:e,n=`ontolookup:${t.ontologyType||"custom"}:${i}`,o=h.ontologyCache.get(n),r=h.escapeHtml(e),l=t.showId!==!1,c=t.maxLength||50,d=t.style||"inline";let u="#";return t.urlTemplate&&(u=t.urlTemplate.replace(/\{id\}/g,encodeURIComponent(i))),o&&Date.now()-o.timestamp<h.cacheTimeout?h.formatOntologyLookupTerm(i,r,o.name,u,l,c,d):(h.lookupOntologyDescription(i,t,n),h.formatOntologyLookupTerm(i,r,null,u,l,c,d))}static formatOntologyLookupTerm(e,t,a,s,i,n,o){const r=h.escapeHtml(e),l=s!=="#",c=l?`href="${s}" target="_blank" rel="noopener noreferrer"`:"",d=l?"a":"span";if(o==="badge"){if(a){const u=a.length>n?a.substring(0,n)+"":a,g=`${t}: ${a}`;return`<${d} ${c} class="ts-badge ts-ontology-lookup-badge" data-term="${r}" title="${h.escapeHtml(g)}" style="text-decoration:none">
                    ${i?`<span class="ts-ontology-id">${r}</span>: `:""}
                    <span class="ts-ontology-name">${h.escapeHtml(u)}</span>
                </${d}>`}return`<${d} ${c} class="ts-badge ts-ontology-lookup-badge ts-loading-term" data-term="${r}" title="${t}" style="text-decoration:none">${r}</${d}>`}if(a){const u=a.length>n?a.substring(0,n)+"":a,g=`${t}: ${a}`;return`<${d} ${c} class="ts-ontology-lookup" data-term="${r}" title="${h.escapeHtml(g)}">
                ${i?`<span class="ts-ontology-id">${r}</span>: `:""}
                <span class="ts-ontology-name">${h.escapeHtml(u)}</span>
            </${d}>`}return`<${d} ${c} class="ts-ontology-lookup ts-loading-term" data-term="${r}" title="${t}">
            <span class="ts-ontology-id">${r}</span>
            <span class="ts-loading-indicator"></span>
        </${d}>`}static async lookupOntologyDescription(e,t,a){try{let s=null;switch(t.ontologyType||"custom"){case"modelseed_reactions":s=await h.lookupModelSeedReaction(e);break;case"modelseed_compounds":s=await h.lookupModelSeedCompound(e);break;case"go":{const n=await h.lookupGOTerm(e);n&&(s=n.name);break}case"kegg":{const n=await h.lookupKEGGEntry(e);n&&(s=n.name);break}case"uniprot":{const n=await h.lookupUniProt(e);n&&(s=n.name);break}case"pfam":{const n=await h.lookupPfamDomain(e);n&&(s=n.name);break}case"cog":{const n=await h.lookupCOG(e);n&&(s=n.name);break}case"ec":{const n=await h.lookupECNumber(e);n&&(s=n.name);break}case"so":{const n=await h.lookupSequenceOntology(e);n&&(s=n.name);break}case"uniref":{const n=await h.lookupUniRef(e);n&&(s=n.name);break}case"custom":if(t.apiUrl){const n=t.apiUrl.replace(/\{id\}/g,encodeURIComponent(e)),o=await fetch(n);if(o.ok){const r=await o.json();s=r.name||r.definition||r.equation||null}}break}s&&(h.ontologyCache.set(a,{name:s,timestamp:Date.now()}),h.updateOntologyLookupElements(e,s,t))}catch(s){w.warn(`Ontology lookup failed for ${e}`,s)}}static async lookupModelSeedReaction(e){var t,a;try{const s=await fetch(`https://modelseed.org/solr/reactions/select?q=id:${e}&wt=json`);if(!s.ok)return null;const i=await s.json();if(((a=(t=i.response)==null?void 0:t.docs)==null?void 0:a.length)>0){const n=i.response.docs[0];return n.definition||n.name||n.equation||null}return null}catch{return null}}static async lookupModelSeedCompound(e){var t,a;try{const s=await fetch(`https://modelseed.org/solr/compounds/select?q=id:${e}&wt=json`);if(!s.ok)return null;const i=await s.json();if(((a=(t=i.response)==null?void 0:t.docs)==null?void 0:a.length)>0){const n=i.response.docs[0];return n.name||n.formula||null}return null}catch{return null}}static async lookupGOTerm(e){var t,a;try{const s=e.startsWith("GO:")?e:`GO:${e}`,i=await fetch(`https://www.ebi.ac.uk/QuickGO/services/ontology/go/terms/${encodeURIComponent(s)}`,{headers:{Accept:"application/json"}});if(!i.ok)return null;const o=(t=(await i.json()).results)==null?void 0:t[0];return o!=null&&o.name?{name:o.name,description:(a=o.definition)==null?void 0:a.text}:null}catch{return null}}static async lookupKEGGEntry(e){try{const t=e.replace(/^KEGG:/i,"").replace(/^ko:/i,"").trim(),a=await fetch(`https://rest.kegg.jp/get/${t}`);if(!a.ok)return null;const s=await a.text();let i=null,n;const o=s.match(/^DEFINITION\s+(.+?)(?:\n|$)/m);o&&(i=o[1].trim());const r=s.match(/^NAME\s+(.+?)(?:\n|$)/m);if(r){const l=r[1].trim();i?n=l:i=l}return i?{name:i,description:n}:null}catch{return null}}static async lookupUniProt(e){var t,a,s,i,n,o,r,l,c,d;try{const u=e.replace(/^UniProtKB:/i,"").trim(),g=await fetch(`https://rest.uniprot.org/uniprotkb/${u}.json`);if(!g.ok)return null;const f=await g.json(),y=(s=(a=(t=f.proteinDescription)==null?void 0:t.recommendedName)==null?void 0:a.fullName)==null?void 0:s.value,p=(r=(o=(n=(i=f.proteinDescription)==null?void 0:i.submissionNames)==null?void 0:n[0])==null?void 0:o.fullName)==null?void 0:r.value,v=y||p||"Unknown Protein",S=(d=(c=(l=f.genes)==null?void 0:l[0])==null?void 0:c.geneName)==null?void 0:d.value;return{name:v,description:S?`Gene: ${S}`:void 0}}catch{return null}}static async lookupPfamDomain(e){var t,a,s,i;try{const n=e.startsWith("PF")?e:`PF${e}`,o=await fetch(`https://www.ebi.ac.uk/interpro/api/entry/pfam/${n}`,{headers:{Accept:"application/json"}});if(!o.ok)return null;const r=await o.json(),l=((a=(t=r.metadata)==null?void 0:t.name)==null?void 0:a.name)||((s=r.metadata)==null?void 0:s.name),c=(i=r.metadata)!=null&&i.description?r.metadata.description[0]:void 0;return c?{name:c,description:l}:l?{name:l}:null}catch{return null}}static async lookupCOG(e){try{const t=e.replace(/^COG:/i,"").trim();return t.length===1&&/^[A-Z]$/i.test(t)?await h.lookupCOGCategory(t.toUpperCase()):/^COG\d+$/i.test(t)?await h.lookupCOGId(t.toUpperCase()):null}catch{return null}}static async lookupCOGCategory(e){var t,a;try{const s=await fetch(`https://www.ncbi.nlm.nih.gov/research/cog/api/cog/?cat=${encodeURIComponent(e)}&format=json`);if(s.ok){const i=await s.json();if((a=(t=i.results)==null?void 0:t[0])!=null&&a.fun_cat_description)return{name:i.results[0].fun_cat_description}}return null}catch{return null}}static async lookupCOGId(e){try{const t=await fetch(`https://www.ncbi.nlm.nih.gov/research/cog/api/cog/${encodeURIComponent(e)}/?format=json`);if(!t.ok)return null;const a=await t.json();return a.cog_name?{name:a.cog_name,description:a.fun_cat_description}:a.fun_cat_description?{name:a.fun_cat_description}:null}catch{return null}}static async lookupECNumber(e){try{const t=e.replace(/^EC:/i,"").trim(),a=await fetch(`https://rest.kegg.jp/get/ec:${t}`);if(!a.ok)return null;const s=await a.text();let i=null;const n=s.match(/^NAME\s+(.+?)(?:\n|$)/m);n&&(i=n[1].split(";")[0].trim());const o=s.match(/^CLASS\s+(.+?)(?:\n|$)/m);return i?{name:i,description:o?o[1].trim():void 0}:null}catch{return null}}static async lookupSequenceOntology(e){var t,a,s;try{const n=(e.startsWith("SO:")?e:`SO:${e}`).replace(":","_"),o=await fetch(`https://www.ebi.ac.uk/ols4/api/ontologies/so/terms?iri=http://purl.obolibrary.org/obo/${n}`,{headers:{Accept:"application/json"}});if(o.ok){const r=await o.json();if((s=(a=(t=r._embedded)==null?void 0:t.terms)==null?void 0:a[0])!=null&&s.label)return{name:r._embedded.terms[0].label,description:r._embedded.terms[0].description?r._embedded.terms[0].description[0]:void 0}}return null}catch{return null}}static async lookupUniRef(e){var t,a,s,i,n,o,r,l,c;try{let d=e;const u=e.match(/UniRef\d+_(\w+)/i);u&&(d=u[1]);const g=await fetch(`https://rest.uniprot.org/uniprotkb/${d}.json`);if(!g.ok)return null;const f=await g.json(),y=f.proteinDescription;let p=null;if((a=(t=y==null?void 0:y.recommendedName)==null?void 0:t.fullName)!=null&&a.value?p=y.recommendedName.fullName.value:(n=(i=(s=y==null?void 0:y.submissionNames)==null?void 0:s[0])==null?void 0:i.fullName)!=null&&n.value&&(p=y.submissionNames[0].fullName.value),p){const v=(c=(l=(r=(o=f.comments)==null?void 0:o.find(S=>S.type==="FUNCTION"))==null?void 0:r.texts)==null?void 0:l[0])==null?void 0:c.value;return{name:p,description:v}}return null}catch{return null}}static updateOntologyLookupElements(e,t,a){const s=a.maxLength||50,i=a.showId!==!1,n=t.length>s?t.substring(0,s)+"":t;document.querySelectorAll(`.ts-ontology-lookup[data-term="${e}"], .ts-ontology-lookup-badge[data-term="${e}"]`).forEach(r=>{r.classList.remove("ts-loading-term"),r.setAttribute("title",`${e}: ${t}`);const l=i?`<span class="ts-ontology-id">${h.escapeHtml(e)}</span>: `:"";r.innerHTML=`${l}<span class="ts-ontology-name">${h.escapeHtml(n)}</span>`})}static register(e,t){h.customTransformers.set(e,t),w.info(`Registered custom transformer: ${e}`)}static unregister(e){return h.customTransformers.delete(e)}static getAvailableTransformers(){const e=["number","percentage","currency","filesize","duration","date","datetime","boolean","heatmap","progress","link","replace","merge","badge","array","sequence","truncate","ontology","ontologyLookup","lookup","chain","conditional"],t=Array.from(h.customTransformers.keys());return[...e,...t]}static custom(e,t,a){const s=h.customTransformers.get(t.functionName);if(!s)return e?String(e):"";try{return s(e,t.params||{},a)}catch(i){return console.error("Custom transformer error",i),e?String(e):""}}};m(h,"ontologyCache",new Map),m(h,"lookupCache",new Map),m(h,"cacheTimeout",36e5),m(h,"customTransformers",new Map);let N=h;class Se extends ee{constructor(t){super(t);m(this,"stateManager");m(this,"options");m(this,"tooltip",null);m(this,"focusedFilterCol",null);m(this,"selectionStart",null);m(this,"selectionEnd",null);m(this,"filterDebounceTimer",null);m(this,"searchMatches",[]);m(this,"currentMatchIndex",-1);m(this,"selection",new Set);this.stateManager=t.stateManager,this.options=t,this.stateManager.subscribe(()=>{this.render()})}render(){const t=this.stateManager.getState();if(t.columns.length===0){this.container.innerHTML=`
                <div class="ts-empty">
                    <div class="ts-empty-icon"><i class="bi bi-inbox-fill"></i></div>
                    <h3 class="ts-empty-title">No Data Loaded</h3>
                    <p class="text-muted">Select a data source from the sidebar to begin.</p>
                </div>`;return}const a=t.columns.filter(o=>t.visibleColumns.has(o.column));if(a.length===0){this.container.innerHTML=`
                <div class="ts-empty">
                    <div class="ts-empty-icon"><i class="bi bi-layout-three-columns"></i></div>
                    <h3 class="ts-empty-title">All Columns Hidden</h3>
                    <p class="text-muted">Enable columns in the sidebar to view data.</p>
                </div>`;return}const s=t.searchValue?t.searchValue.trim().toLowerCase():"";let i='<table class="ts-table"><thead><tr>';const n=t.data.length>0&&t.data.every((o,r)=>this.selection.has(r));if(i+=`<th class="ts-col-select ts-col-fixed"><input type="checkbox" id="ts-select-all" ${n?"checked":""}></th>`,t.showRowNumbers&&(i+='<th class="ts-col-num ts-col-fixed">#</th>'),a.forEach((o,r)=>{const c=r===0&&!t.showRowNumbers?"ts-col-fixed":"",d=o.sortable?"sortable":"",u=t.sortColumn===o.column?t.sortOrder==="asc"?' <i class="bi bi-sort-up"></i>':' <i class="bi bi-sort-down"></i>':"",g=o.width&&o.width!=="auto"?`width:${o.width}`:"min-width:80px";i+=`<th class="${c} ${d}" data-col="${o.column}" style="${g}">${o.displayName||o.column}${u}</th>`}),i+='</tr><tr class="ts-filter-row">',i+='<th class="ts-col-select ts-col-fixed" style="width:48px"></th>',t.showRowNumbers&&(i+='<th class="ts-col-num ts-col-fixed" style="width:60px"></th>'),a.forEach((o,r)=>{const c=r===0&&!t.showRowNumbers?"ts-col-fixed":"",d=t.columnFilters[o.column]||"",u=o.width&&o.width!=="auto"?`width:${o.width}`:"min-width:80px",g=this.options.getColumnType?this.options.getColumnType(o.column):"TEXT",f=["INTEGER","REAL","NUMERIC"].includes(g.toUpperCase()),y=f?"e.g., <500, >=100, =50":"Filter...",p=f?"Supports: <, <=, >, >=, =, !=, between, or just number":"Text search, =value, !=value, in(list), between";i+=`<th class="${c}" style="${u}">`,o.filterable!==!1?i+=`<div class="ts-filter-wrap"><input class="ts-filter-input ${d?"has-value":""}" data-col="${o.column}" data-type="${g}" value="${N.escapeHtml(d)}" placeholder="${y}" title="${p}"><button class="ts-filter-clear" data-col="${o.column}"><i class="bi bi-x"></i></button></div>`:i+='<div style="height:28px"></div>',i+="</th>"}),i+="</tr></thead><tbody>",t.data.length===0){const o=a.length+(t.showRowNumbers?1:0);i+=`<tr><td colspan="${o}" style="text-align:center;padding:32px;color:var(--text-muted)"><i class="bi bi-search" style="font-size:20px;opacity:.3;display:block;margin-bottom:6px"></i>No matching records</td></tr>`}else{const o=t.currentPage*t.pageSize+1;t.data.forEach((r,l)=>{const c=this.isRowSelected(l),d=o+l;i+=`<tr class="${c?"selected":""}" data-idx="${l}">`,i+=`<td class="ts-col-select ts-col-fixed"><input type="checkbox" class="ts-row-checkbox" data-idx="${l}" ${c?"checked":""}></td>`,t.showRowNumbers&&(i+=`<td class="ts-col-num ts-col-fixed">${d}</td>`),a.forEach((u,g)=>{const y=g===0&&!t.showRowNumbers?"ts-col-fixed":"",p=r[u.column];let v="";const S=p!=null?String(p):"";if(u.transform)v=N.apply(p,u.transform,r);else if(u.column.includes("ID")||u.column==="ID"){const C=N.escapeHtml(S);v=`<span class="ts-copy-id"><span class="ts-mono">${C}</span><button class="ts-copy-btn" data-id="${C}"><i class="bi bi-clipboard"></i></button></span>`}else v=N.escapeHtml(S);s&&s.trim()&&(v=this.highlightText(v,s).content),i+=`<td class="${y}" data-row="${l}" data-col="${u.column}">${v}</td>`}),i+="</tr>"})}i+="</tbody></table>",this.container.innerHTML=i,t.searchValue&&t.searchValue.trim()?this.trackSearchMatches(t.searchValue.trim()):(this.searchMatches=[],this.currentMatchIndex=-1),this.bindEvents(),this.restoreFocus()}restoreFocus(){if(this.focusedFilterCol){const t=this.container.querySelector(`input.ts-filter-input[data-col="${this.focusedFilterCol}"]`);t&&(t.focus(),this.selectionStart!==null&&this.selectionEnd!==null&&t.setSelectionRange(this.selectionStart,this.selectionEnd))}}getSelection(){return this.selection}clearSelection(){this.selection.clear(),this.render()}selectAll(){this.stateManager.getState().data.forEach((a,s)=>this.selection.add(s)),this.render(),this.options.onRowSelect(-1,!0,!0)}clearFilterFocus(){this.focusedFilterCol=null,this.selectionStart=null,this.selectionEnd=null,this.filterDebounceTimer&&(clearTimeout(this.filterDebounceTimer),this.filterDebounceTimer=null)}isRowSelected(t){return this.selection.has(t)}bindEvents(){this.container.addEventListener("change",t=>{const a=t.target;if(a.id==="ts-select-all"){const s=this.stateManager.getState();a.checked?s.data.forEach((i,n)=>this.selection.add(n)):this.selection.clear(),this.render(),this.options.onRowSelect(-1,a.checked,!0);return}if(a.classList.contains("ts-row-checkbox")){const s=parseInt(a.dataset.idx||"-1");s>=0&&(a.checked?this.selection.add(s):this.selection.delete(s),this.render(),this.options.onRowSelect(s,a.checked));return}}),this.container.onclick=t=>{const a=t.target,s=a.closest("th.sortable");if(s){const o=s.dataset.col;if(o){const r=this.stateManager.getState(),l=r.sortColumn===o&&r.sortOrder==="asc"?"desc":"asc";this.options.onSort(o,l)}return}const i=a.closest(".ts-filter-clear");if(i){const o=i.dataset.col;o&&this.options.onFilter(o,"");return}const n=a.closest(".ts-copy-btn");if(n){const o=n.dataset.id;o&&navigator.clipboard.writeText(o)}},this.container.ondblclick=t=>{const a=t.target;if(a.closest("button")||a.closest("input")||a.closest("a"))return;const s=a.closest("td[data-row][data-col]");if(!s)return;const i=s.innerText.trim();i&&navigator.clipboard&&typeof navigator.clipboard.writeText=="function"&&navigator.clipboard.writeText(i).catch(()=>{})},this.container.oninput=t=>{const a=t.target;if(a.classList.contains("ts-filter-input")){const s=a.dataset.col;s&&(this.focusedFilterCol=s,this.selectionStart=a.selectionStart,this.selectionEnd=a.selectionEnd,this.filterDebounceTimer&&clearTimeout(this.filterDebounceTimer),this.filterDebounceTimer=setTimeout(()=>{this.options.onFilter(s,a.value)},300))}},this.container.onkeyup=t=>{const a=t.target;a.classList.contains("ts-filter-input")&&(this.selectionStart=a.selectionStart,this.selectionEnd=a.selectionEnd)},this.container.addEventListener("focusin",t=>{const a=t.target;a.classList.contains("ts-filter-input")?this.focusedFilterCol=a.dataset.col||null:this.focusedFilterCol=null}),this.container.onmouseover=t=>{var s;const a=t.target.closest("td");if(a&&a.scrollWidth>a.clientWidth){const i=(s=a.textContent)==null?void 0:s.trim();i&&this.showTooltip(t,i)}},this.container.onmouseout=t=>{t.target.closest("td")&&this.hideTooltip()}}showTooltip(t,a){this.tooltip||(this.tooltip=document.createElement("div"),this.tooltip.className="ts-tooltip",this.tooltip.id="ts-tooltip",document.body.appendChild(this.tooltip)),this.tooltip.textContent=a,this.tooltip.classList.add("show"),this.tooltip.style.left=t.clientX+10+"px",this.tooltip.style.top=t.clientY+10+"px"}hideTooltip(){this.tooltip&&this.tooltip.classList.remove("show")}highlightText(t,a){if(!a||!a.trim())return{content:t,hasMatches:!1};const s=a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(`(${s})`,"gi"),n=document.createElement("div");n.innerHTML=t;const o=(n.textContent||n.innerText||"").toLowerCase();if(!o.includes(a.toLowerCase()))return{content:t,hasMatches:!1};if(!t.includes("<")||t===N.escapeHtml(o))return i.lastIndex=0,{content:t.replace(i,'<mark class="highlight">$1</mark>'),hasMatches:!0};const l=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,null),c=[];let d;for(;d=l.nextNode();)if(d.textContent&&(i.lastIndex=0,i.test(d.textContent))){i.lastIndex=0;const u=d.textContent.replace(i,'<mark class="highlight">$1</mark>');c.push({node:d,replacement:u})}return c.forEach(({node:u,replacement:g})=>{const f=u.parentElement;if(f){const y=document.createElement("span");for(y.innerHTML=g;y.firstChild;)f.insertBefore(y.firstChild,u);f.removeChild(u)}}),{content:n.innerHTML,hasMatches:c.length>0}}trackSearchMatches(t){if(this.searchMatches=[],!t||!t.trim()){this.currentMatchIndex=-1;return}this.container.querySelectorAll("mark.highlight").forEach(s=>{const i=s.closest("td[data-row][data-col]");i&&this.searchMatches.push({element:s,row:parseInt(i.getAttribute("data-row")||"0"),col:0})}),this.searchMatches.length>0?(this.currentMatchIndex=0,this.highlightCurrentMatch()):this.currentMatchIndex=-1}navigateToNextMatch(){return this.searchMatches.length===0?!1:(this.currentMatchIndex=(this.currentMatchIndex+1)%this.searchMatches.length,this.highlightCurrentMatch(),!0)}navigateToPreviousMatch(){return this.searchMatches.length===0?!1:(this.currentMatchIndex=this.currentMatchIndex<=0?this.searchMatches.length-1:this.currentMatchIndex-1,this.highlightCurrentMatch(),!0)}highlightCurrentMatch(){if(this.container.querySelectorAll("mark.highlight").forEach(t=>{t.classList.remove("active")}),this.currentMatchIndex>=0&&this.currentMatchIndex<this.searchMatches.length){const t=this.searchMatches[this.currentMatchIndex];t.element.classList.add("active"),this.scrollToMatch(t.element)}}scrollToMatch(t){const a=t.closest("td");if(!a)return;const s=this.container.closest(".ts-grid");if(!s)return;const i=a.getBoundingClientRect(),n=s.getBoundingClientRect(),o=50;if(!(i.top>=n.top+o&&i.bottom<=n.bottom-o&&i.left>=n.left+o&&i.right<=n.right-o)){const l=s,c=a.offsetTop,d=a.offsetLeft,u=l.clientHeight,g=l.clientWidth,f=c-u/2+a.clientHeight/2,y=d-g/2+a.clientWidth/2;l.scrollTo({top:Math.max(0,f),left:Math.max(0,y),behavior:"smooth"})}}getSearchMatchInfo(){return{current:this.currentMatchIndex>=0?this.currentMatchIndex+1:0,total:this.searchMatches.length}}hasSearchMatches(){return this.searchMatches.length>0}}class Ce{constructor(e){m(this,"configManager");m(this,"stateManager");m(this,"client");m(this,"createModal");m(this,"switchTable");m(this,"fetchData");m(this,"getSchemaForTable");m(this,"getConfigColumns");m(this,"getStateColumns");m(this,"searchTerm","");m(this,"searchResults",[]);m(this,"isSearchingData",!1);m(this,"modal",null);m(this,"schemaCache",{});m(this,"loadingTables",new Set);this.configManager=e.configManager,this.stateManager=e.stateManager,this.client=e.client,this.createModal=e.createModal,this.switchTable=e.switchTable.bind(e.switchTable),this.fetchData=e.fetchData.bind(e.fetchData),this.getSchemaForTable=e.getSchemaForTable,this.getConfigColumns=e.getConfigColumns,this.getStateColumns=e.getStateColumns}renderSchemaItem(e){const t=[];e.sortable&&t.push({l:"Sortable",bg:"#dbeafe",fg:"#1d4ed8"}),e.filterable&&t.push({l:"Filterable",bg:"#d1fae5",fg:"#059669"}),e.copyable&&t.push({l:"Copyable",bg:"#e2e8f0",fg:"#475569"}),e.pin&&t.push({l:"Pinned",bg:"#ede9fe",fg:"#7c3aed"}),e.pk&&t.push({l:"Primary",bg:"#fee2e2",fg:"#b91c1c"}),e.notnull&&t.push({l:"Not Null",bg:"#fef9c3",fg:"#92400e"});const a=t.map(i=>`<span style="font-size:10px;padding:3px 8px;border-radius:4px;background:${i.bg};color:${i.fg};margin-right:6px;font-weight:500">${i.l}</span>`).join(""),s=(e.type||e.dataType||"string").toString().toUpperCase();return`
            <div class="ts-schema-item">
                <div style="padding-top:4px;flex-shrink:0"><i class="bi bi-hash" style="color:var(--c-accent);font-size:16px"></i></div>
                <div style="flex:1;min-width:0">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;gap:12px">
                        <span class="ts-schema-name">${e.displayName||e.column}</span>
                        <span class="ts-schema-type">${s}</span>
                    </div>
                    ${e.description?`<div class="ts-schema-desc">${e.description}</div>`:""}
                    <div style="display:flex;align-items:center;margin-top:8px;flex-wrap:wrap;gap:4px">
                        ${a}
                        <span style="font-size:11px;color:var(--c-text-muted);font-family:'JetBrains Mono',monospace;margin-left:auto">col: ${e.column}</span>
                    </div>
                </div>
            </div>
        `}async show(e){const t=this.stateManager.getState(),a=t.availableTables||[],s=e||null;this.searchTerm="",this.searchResults=[],this.isSearchingData=!1;const i=(p,v="")=>{const S=v.trim().length>0;return`
                <div class="glass-sidebar" style="width:260px;display:flex;flex-direction:column;height:100%">
                    <div style="padding:16px;border-bottom:1px solid var(--c-border-subtle)">
                        <h3 style="font-size:11px;text-transform:uppercase;color:var(--c-text-muted);font-weight:700;letter-spacing:0.08em;display:flex;align-items:center;gap:8px;margin-bottom:12px">
                            <i class="bi bi-database" style="font-size:14px"></i> Database Schema
                        </h3>
                        <div style="position:relative;margin-bottom:8px">
                            <input type="text" id="ts-db-search" placeholder="Search tables, columns, data..." 
                                value="${v}"
                                style="background:var(--c-bg-input);border:1px solid var(--c-border-subtle);border-radius:var(--radius-sm);font-size:12px;padding:6px 12px 6px 32px;width:100%;outline:none;color:var(--c-text-primary);box-sizing:border-box">
                            <i class="bi bi-search" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--c-text-muted);pointer-events:none"></i>
                            ${S?'<button id="ts-db-search-clear" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--c-text-muted);cursor:pointer;padding:2px;font-size:14px"><i class="bi bi-x"></i></button>':""}
                        </div>
                        ${S?`
                            <div style="display:flex;gap:4px;margin-top:4px">
                                <button id="ts-search-data-btn" class="ts-btn-secondary" style="flex:1;height:28px;font-size:11px;padding:0 8px;${this.isSearchingData?"opacity:0.6":""}" ${this.isSearchingData?"disabled":""}>
                                    <i class="bi bi-${this.isSearchingData?"hourglass-split":"search"}"></i> ${this.isSearchingData?"Searching...":"Search Data"}
                                </button>
                            </div>
                        `:""}
                    </div>
                    <div style="flex:1;overflow-y:auto;padding:12px">
                        ${S?`
                            <div style="margin-bottom:8px;padding:0 14px">
                                <span style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--c-text-muted);font-weight:600">
                                    ${this.searchResults.length>0?`Results (${this.searchResults.length})`:"No Results"}
                                </span>
                            </div>
                            ${this.searchResults.length>0?this.searchResults.map(C=>{const T=C.columns.length+(C.hasDataMatches?1:0);return`
                                    <div class="ts-nav-item ${p===C.table.name?"active":""}" 
                                         data-target="${C.table.name}" 
                                         data-search="${v}"
                                         style="cursor:pointer">
                                        <i class="bi bi-table"></i> 
                                        <div style="flex:1;min-width:0">
                                            <div style="font-weight:${p===C.table.name?"600":"500"}">${C.table.name}</div>
                                            <div style="font-size:10px;color:var(--c-text-muted);margin-top:2px">
                                                ${T} match${T!==1?"es":""}
                                                ${C.hasDataMatches?"  Has data matches":""}
                                            </div>
                                        </div>
                                    </div>
                                `}).join(""):`
                                <div style="padding:24px;text-align:center;color:var(--c-text-muted)">
                                    <i class="bi bi-search" style="font-size:24px;display:block;margin-bottom:8px;opacity:0.5"></i>
                                    <div style="font-size:12px">No matches found</div>
                                </div>
                            `}
                        `:`
                            <div class="ts-nav-item ${p?"":"active"}" data-target="__overview__">
                                <i class="bi bi-grid-1x2"></i> Overview
                            </div>
                            <div style="margin-top:12px;margin-bottom:8px;padding:0 14px">
                                <span style="font-size:10px;text-transform:uppercase;letter-spacing:0.08em;color:var(--c-text-muted);font-weight:600">Tables (${a.length})</span>
                            </div>
                            ${a.map(C=>`
                                <div class="ts-nav-item ${p===C.name?"active":""}" data-target="${C.name}">
                                    <i class="bi bi-table"></i> 
                                    <span style="flex:1">${C.name}</span>
                                    <span style="font-size:11px;color:var(--c-text-muted)">${(C.row_count||0).toLocaleString()}</span>
                                </div>
                            `).join("")}
                        `}
                    </div>
                </div>
            `},n=()=>{const p=a.length,v=a.reduce((S,C)=>S+(C.row_count||0),0);return this.searchTerm&&this.searchResults.length>0?`
                    <div style="padding:40px;max-width:960px;margin:0 auto">
                        <div style="margin-bottom:32px">
                            <h2 style="font-size:24px;font-weight:700;color:var(--c-text-primary);margin-bottom:8px">
                                Search Results for "${this.searchTerm}"
                            </h2>
                            <p style="color:var(--c-text-secondary);font-size:14px">Found ${this.searchResults.length} table${this.searchResults.length!==1?"s":""} with matches</p>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:16px">
                            ${this.searchResults.map(S=>{const C=S.columns.length+(S.hasDataMatches?1:0);return`
                                    <div class="ts-card-nav" data-target="${S.table.name}" data-search="${this.searchTerm}" style="cursor:pointer">
                                        <div style="width:44px;height:44px;background:var(--c-accent-light);border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--c-accent);font-size:20px">
                                            <i class="bi bi-table"></i>
                                        </div>
                                        <div style="flex:1">
                                            <div style="font-weight:600;font-size:14px;color:var(--c-text-primary)">${S.table.name}</div>
                                            <div style="font-size:12px;color:var(--c-text-muted);margin-top:4px">
                                                ${C} match${C!==1?"es":""}
                                                ${S.hasDataMatches?"  Data matches":""}
                                                ${S.columns.length>0?`  ${S.columns.length} column${S.columns.length!==1?"s":""}`:""}
                                            </div>
                                            ${S.columns.length>0?`
                                                <div style="margin-top:8px;font-size:11px;color:var(--c-text-muted);max-height:60px;overflow-y:auto">
                                                    ${S.columns.slice(0,3).map(T=>`
                                                        <div style="padding:2px 0"> ${T.displayName||T.column}</div>
                                                    `).join("")}
                                                    ${S.columns.length>3?`<div style="padding:2px 0;font-style:italic">+ ${S.columns.length-3} more</div>`:""}
                                                </div>
                                            `:""}
                                        </div>
                                        <i class="bi bi-chevron-right" style="font-size:14px;color:var(--c-text-muted)"></i>
                                    </div>
                                `}).join("")}
                        </div>
                    </div>
                `:`
                <div style="padding:48px;max-width:900px;margin:0 auto">
                    <div style="text-align:center;margin-bottom:48px">
                        <div style="width:80px;height:80px;background:linear-gradient(135deg, var(--c-accent-light) 0%, var(--c-accent-glow) 100%);color:var(--c-accent);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:40px;margin:0 auto 20px;box-shadow:0 8px 24px var(--c-accent-glow)">
                            <i class="bi bi-database"></i>
                        </div>
                        <h2 style="font-size:28px;font-weight:700;color:var(--c-text-primary);margin-bottom:8px">Database Overview</h2>
                        <p style="color:var(--c-text-secondary);font-size:14px">${t.berdlTableId||"Connected Database"}</p>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:20px;margin-bottom:48px">
                        <div class="glass-panel" style="padding:28px;text-align:center">
                            <div style="font-size:13px;color:var(--c-text-muted);margin-bottom:8px;font-weight:500">Total Tables</div>
                            <div style="font-size:40px;font-weight:700;color:var(--c-text-primary)">${p}</div>
                        </div>
                        <div class="glass-panel" style="padding:28px;text-align:center">
                            <div style="font-size:13px;color:var(--c-text-muted);margin-bottom:8px;font-weight:500">Total Records</div>
                            <div style="font-size:40px;font-weight:700;color:var(--c-text-primary)">${v.toLocaleString()}</div>
                        </div>
                    </div>
                    <h3 style="font-size:12px;font-weight:700;margin-bottom:20px;color:var(--c-text-muted);text-transform:uppercase;letter-spacing:0.08em">Available Tables</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:16px">
                        ${a.map(S=>`
                            <div class="ts-card-nav" data-target="${S.name}">
                                <div style="width:44px;height:44px;background:var(--c-accent-light);border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--c-accent);font-size:20px"><i class="bi bi-table"></i></div>
                                <div style="flex:1">
                                    <div style="font-weight:600;font-size:14px;color:var(--c-text-primary)">${S.name}</div>
                                    <div style="font-size:12px;color:var(--c-text-muted);margin-top:2px">${(S.row_count||0).toLocaleString()} records</div>
                                </div>
                                <i class="bi bi-chevron-right" style="font-size:14px;color:var(--c-text-muted)"></i>
                            </div>
                        `).join("")}
                    </div>
                </div>
            `},o=p=>{if(!p)return"STRING";const v=p.toUpperCase();return v.includes("INT")?"INTEGER":v.includes("REAL")||v.includes("DOUBLE")||v.includes("FLOAT")?"FLOAT":v.includes("CHAR")||v.includes("TEXT")||v.includes("CLOB")?"STRING":v.includes("BLOB")?"BLOB":v.includes("DATE")||v.includes("TIME")?"DATETIME":v},r=p=>{const v=this.configManager.getTableConfig(p),T=this.stateManager.getState().activeTableName===p?this.getStateColumns():[],x=this.schemaCache[p],k=x&&x.length>0?x:T.length>0?T:(v==null?void 0:v.columns)||[];if(x&&x.length>0)return x;const $=new Map(((v==null?void 0:v.columns)||[]).map(M=>[M.column,M]));return k.map(M=>{const L=M.column||M.name,E=$.get(L)||{},D=o(M.type||E.dataType||E.type);return{...E,...M,column:L,type:D,dataType:D}})},l=p=>{var $;const v=this.configManager.getTableConfig(p),S=t.activeTableName===p,C=r(p),T=this.loadingTables.has(p),x=(v==null?void 0:v.name)||p,k=(v==null?void 0:v.description)||"No description available for this table.";return`
                <div style="padding:40px;max-width:960px;margin:0 auto">
                    <div style="margin-bottom:36px">
                        <div style="display:flex;align-items:flex-start;gap:20px">
                            <div style="width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg, var(--c-accent-light) 0%, var(--c-accent-glow) 100%);color:var(--c-accent);display:flex;align-items:center;justify-content:center;font-size:32px;flex-shrink:0;box-shadow:0 4px 16px var(--c-accent-glow)">
                                <i class="${(v==null?void 0:v.icon)||"bi bi-table"}"></i>
                            </div>
                            <div style="flex:1">
                                <h2 style="font-size:24px;font-weight:700;color:var(--c-text-primary);margin:0 0 8px 0">${x}</h2>
                                <div style="font-size:14px;color:var(--c-text-secondary);line-height:1.6;margin-bottom:16px;max-width:600px">
                                    ${k}
                                </div>
                                <div style="display:flex;gap:20px;font-size:13px;color:var(--c-text-muted)">
                                    <span style="display:flex;align-items:center;gap:6px"><i class="bi bi-layout-three-columns"></i> ${C.length} Columns</span>
                                    ${S?`<span style="display:flex;align-items:center;gap:6px"><i class="bi bi-list-ol"></i> ${($=t.totalCount)==null?void 0:$.toLocaleString()} Records</span>`:""}
                                    <span style="display:flex;align-items:center;gap:6px"><i class="bi bi-${S?'check-circle-fill" style="color:var(--success)':"circle"}"></i> ${S?"Currently Loaded":"Not Loaded"}</span>
                                </div>
                            </div>
                            <button id="ts-export-current" class="ts-btn-secondary" data-table="${p}" style="height:40px;padding:0 20px">
                                <i class="bi bi-download"></i> Export Schema
                            </button>
                        </div>
                    </div>
                    <div class="glass-panel" style="overflow:hidden">
                        <div style="padding:14px 20px;border-bottom:1px solid var(--c-border-subtle);display:flex;justify-content:space-between;align-items:center;background:rgba(248,250,252,0.3)">
                            <h4 style="margin:0;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--c-text-muted);display:flex;align-items:center;gap:8px">
                                <i class="bi bi-list-columns-reverse"></i> Schema Definition
                            </h4>
                            <div style="display:flex;align-items:center;gap:8px">
                                <button id="ts-refresh-schema" data-table="${p}" class="ts-btn-secondary" style="height:28px;padding:0 10px;font-size:11px">
                                    <i class="bi bi-arrow-repeat"></i> Refresh schema
                                </button>
                                <div style="position:relative">
                                <input type="text" id="ts-schema-filter" placeholder="Search columns..." style="background:var(--c-bg-input);border:1px solid var(--c-border-subtle);border-radius:var(--radius-sm);font-size:12px;padding:6px 12px 6px 32px;width:220px;outline:none;color:var(--c-text-primary)">
                                <i class="bi bi-search" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--c-text-muted)"></i>
                            </div>
                            </div>
                        </div>
                        <div id="ts-schema-items-container" style="max-height:55vh;overflow-y:auto">
                            ${T?'<div style="padding:48px;text-align:center;color:var(--c-text-muted)"><i class="bi bi-hourglass-split" style="font-size:24px;display:block;margin-bottom:12px;opacity:0.5"></i>Loading schema...</div>':C.length===0?'<div style="padding:48px;text-align:center;color:var(--c-text-muted)"><i class="bi bi-info-circle" style="font-size:24px;display:block;margin-bottom:12px;opacity:0.5"></i>No schema information yet. Click "Refresh schema" to fetch live schema.</div>':C.map(M=>this.renderSchemaItem(M)).join("")}
                        </div>
                    </div>
                </div>
             `},c=async p=>{if(!(!p||this.schemaCache[p]||this.loadingTables.has(p))){this.loadingTables.add(p),d(p);try{const v=await this.getSchemaForTable(p),S=this.getConfigColumns(p),C=new Map(S.map(x=>[x.column,x])),T=v.map(x=>{const k=x.column||x.name,$=C.get(k)||{},M=o(x.type||$.dataType||$.type);return{...$,column:k,displayName:$.displayName||k,type:M,dataType:M,description:$.description,sortable:$.sortable!==!1,filterable:$.filterable!==!1,copyable:$.copyable,pin:$.pin,pk:x.pk,notnull:x.notnull}});this.schemaCache[p]=T.length>0?T:S.map(x=>({...x,column:x.column,type:o(x.dataType||x.type),dataType:o(x.dataType||x.type)}))}catch(v){w.warn(`[SchemaViewer] Failed to load schema for table ${p}`,v)}finally{this.loadingTables.delete(p),d(p)}}},d=(p,v=this.searchTerm)=>{var T,x;const S=(T=this.modal)==null?void 0:T.querySelector("#ts-schema-sidebar"),C=(x=this.modal)==null?void 0:x.querySelector("#ts-schema-main");S&&(S.innerHTML=i(p==="__overview__"?null:p,v)),C&&(C.innerHTML=p==="__overview__"?n():l(p),C.scrollTop=0),g()},u=async(p,v=!1)=>{var T;if(this.searchTerm=p.trim(),this.searchResults=[],!this.searchTerm){d("__overview__");return}const S=this.searchTerm.toLowerCase(),C=this.stateManager.getState();for(const x of a){const k=x.name.toLowerCase().includes(S),$=this.configManager.getTableConfig(x.name),E=(C.activeTableName===x.name?C.columns:($==null?void 0:$.columns)||[]).filter(D=>{const _=(D.displayName||D.column||"").toLowerCase(),z=(D.column||"").toLowerCase(),R=(D.description||"").toLowerCase();return _.includes(S)||z.includes(S)||R.includes(S)});(k||E.length>0)&&this.searchResults.push({table:x,columns:E,hasDataMatches:!1})}if(v&&C.berdlTableId){this.isSearchingData=!0;const x=(T=this.modal)==null?void 0:T.querySelector("#ts-schema-sidebar");x&&(x.innerHTML=i(null,this.searchTerm)),g();const k=a.map(async $=>{try{if((await this.client.getTableData({berdl_table_id:C.berdlTableId||"",table_name:$.name,limit:1,offset:0,search_value:this.searchTerm})).total_count>0){const L=this.searchResults.find(E=>E.table.name===$.name);L?L.hasDataMatches=!0:this.searchResults.push({table:$,columns:[],hasDataMatches:!0})}}catch(M){w.warn(`Failed to search data in table ${$.name}`,M)}});await Promise.all(k),this.isSearchingData=!1}d("__overview__")},g=()=>{if(!this.modal)return;const p=this.modal.querySelector("#ts-db-search"),v=this.modal.querySelector("#ts-db-search-clear"),S=this.modal.querySelector("#ts-search-data-btn");if(p){let x=null;p.addEventListener("input",()=>{const k=p.value;this.searchTerm=k,x&&clearTimeout(x),x=setTimeout(()=>{u(k,!1)},300)}),p.addEventListener("keypress",k=>{k.key==="Enter"&&(k.preventDefault(),x&&clearTimeout(x),u(p.value,!1))})}v&&v.addEventListener("click",()=>{p&&(p.value=""),this.searchTerm="",this.searchResults=[],this.isSearchingData=!1,d("__overview__","")}),S&&S.addEventListener("click",async()=>{!this.searchTerm||this.isSearchingData||await u(this.searchTerm,!0)}),this.modal.querySelectorAll(".ts-nav-item, .ts-card-nav").forEach(x=>{x.addEventListener("click",()=>{var M;const k=x.dataset.target,$=x.dataset.search;if(k)if(k!=="__overview__"&&$){const L=(M=this.modal)==null?void 0:M.querySelector(".ts-modal-close");L&&L.click(),this.switchTable(k).then(()=>{this.stateManager.update({searchValue:$,currentPage:0}),this.fetchData()})}else d(k,$||this.searchTerm),c(k)})});const C=this.modal.querySelector("#ts-schema-filter"),T=this.modal.querySelector("#ts-schema-items-container");if(C&&T&&C.addEventListener("input",()=>{const x=C.value.toLowerCase();T.querySelectorAll(".ts-schema-item").forEach(k=>{const $=(k.textContent||"").toLowerCase();k.style.display=$.includes(x)?"flex":"none"})}),this.modal){const x=this.modal.querySelector("#ts-export-current");x==null||x.addEventListener("click",()=>{var te;const $=x.dataset.table;if(!$)return;const M=this.stateManager.getState(),L=this.configManager.getTableConfig($),E=(te=this.schemaCache[$])!=null&&te.length?this.schemaCache[$]:M.activeTableName===$?M.columns:(L==null?void 0:L.columns)||[],D=JSON.stringify(L||{tableName:$,columns:E},null,2),_=new Blob([D],{type:"application/json"}),z=URL.createObjectURL(_),R=document.createElement("a");R.href=z,R.download=`${$}_schema.json`,document.body.appendChild(R),R.click(),document.body.removeChild(R),URL.revokeObjectURL(z)});const k=this.modal.querySelector("#ts-refresh-schema");k==null||k.addEventListener("click",()=>{const $=k.dataset.table;$&&(delete this.schemaCache[$],c($))})}},f=`
            <div style="display:flex;height:100%;overflow:hidden">
                <div id="ts-schema-sidebar">${i(s||null)}</div>
                <div id="ts-schema-main" style="flex:1;overflow-y:auto;background:var(--c-bg-app-solid);position:relative">
                    ${s?l(s):n()}
                </div>
            </div>
        `;this.modal=this.createModal("Database Explorer",f);const y=this.modal.querySelector(".ts-modal-body");y&&(y.style.padding="0",y.style.height="calc(80vh - 60px)"),g(),e&&c(e)}}class $e{constructor(e){m(this,"stateManager");m(this,"client");m(this,"createModal");m(this,"showAlert");this.stateManager=e.stateManager,this.client=e.client||new Y,this.createModal=e.createModal,this.showAlert=e.showAlert}async show(e){const t=this.stateManager.getState();if(!t.berdlTableId||!e){this.showAlert("No table selected","warning");return}const a=(s,i=2)=>s==null?"N/A":typeof s=="number"?Number.isInteger(s)?s.toLocaleString():s.toFixed(i):String(s);try{this.stateManager.update({loading:!0});const s=await this.client.getTableStatistics(t.berdlTableId,e);if(!s||!Array.isArray(s.columns))throw new Error("Invalid statistics response format");const i=`
                <div style="padding:24px;max-width:900px;overflow-y:auto;max-height:80vh">
                    <h2 style="margin-bottom:20px;font-size:18px;font-weight:600">
                        <i class="bi bi-graph-up"></i> Column Statistics: ${e}
                    </h2>
                    <div style="margin-bottom:16px;padding:12px;background:var(--c-bg-surface-alt);border-radius:var(--radius-sm);font-size:13px">
                        <strong>Total Rows:</strong> ${(s.row_count||0).toLocaleString()}
                    </div>
                    <div style="display:grid;gap:12px">
                        ${s.columns.map(n=>`
                            <div style="padding:16px;background:var(--c-bg-surface);border:1px solid var(--c-border-subtle);border-radius:var(--radius-md)">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                    <h3 style="font-size:14px;font-weight:600">${n.column||"Unknown"}</h3>
                                    <span style="font-size:11px;color:var(--c-text-muted);text-transform:uppercase">${n.type||"TEXT"}</span>
                                </div>
                                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;font-size:12px">
                                    <div><strong>Nulls:</strong> ${(n.null_count??0).toLocaleString()}</div>
                                    <div><strong>Distinct:</strong> ${(n.distinct_count??0).toLocaleString()}</div>
                                    ${n.min!=null?`<div><strong>Min:</strong> ${a(n.min)}</div>`:""}
                                    ${n.max!=null?`<div><strong>Max:</strong> ${a(n.max)}</div>`:""}
                                    ${n.mean!=null?`<div><strong>Mean:</strong> ${a(n.mean,2)}</div>`:""}
                                    ${n.median!=null?`<div><strong>Median:</strong> ${a(n.median)}</div>`:""}
                                    ${n.stddev!=null?`<div><strong>StdDev:</strong> ${a(n.stddev,4)}</div>`:""}
                                </div>
                                ${n.sample_values&&n.sample_values.length>0?`
                                    <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--c-border-subtle)">
                                        <div style="font-size:11px;color:var(--c-text-muted);margin-bottom:6px">Sample Values:</div>
                                        <div style="display:flex;flex-wrap:wrap;gap:4px">
                                            ${n.sample_values.slice(0,10).map(o=>`
                                                <span style="padding:2px 8px;background:var(--c-bg-surface-alt);border-radius:4px;font-size:11px;font-family:monospace">${String(o??"").substring(0,30)}</span>
                                            `).join("")}
                                        </div>
                                    </div>
                                `:""}
                            </div>
                        `).join("")}
                    </div>
                </div>
            `;this.createModal(`Column Statistics: ${e}`,i)}catch(s){w.error(`Failed to load statistics: ${s.message}`,s),this.showAlert(`Failed to load statistics: ${s.message}`,"danger")}finally{this.stateManager.update({loading:!1})}}}class ke{constructor(){m(this,"modal",null)}show(){this.modal&&this.modal.remove();const e=w.getLogHistory();this.modal=document.createElement("div"),this.modal.className="ts-modal-overlay show",this.modal.innerHTML=`
            <div class="ts-modal" style="max-width:800px; max-height:80vh; display:flex; flex-direction:column;">
                <div class="ts-modal-header">
                    <h3><i class="bi bi-terminal"></i> System Logs</h3>
                    <button class="ts-modal-close"><i class="bi bi-x"></i></button>
                </div>
                <div class="ts-modal-body" style="flex:1; overflow:hidden; display:flex; flex-direction:column; padding:0;">
                    <div style="display:flex; gap:8px; padding:12px; border-bottom:1px solid var(--c-border);">
                        <select class="ts-select" id="ts-log-filter" style="width:120px;">
                            <option value="all">All Levels</option>
                            <option value="debug">Debug</option>
                            <option value="info">Info</option>
                            <option value="warn">Warn</option>
                            <option value="error">Error</option>
                        </select>
                        <button class="ts-btn-secondary" id="ts-log-copy">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                        <button class="ts-btn-secondary" id="ts-log-download">
                            <i class="bi bi-download"></i> Download
                        </button>
                        <button class="ts-btn-secondary" id="ts-log-clear">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                        <span style="flex:1;"></span>
                        <span id="ts-log-count" style="color:var(--c-text-muted); font-size:12px; align-self:center;">
                            ${e.length} entries
                        </span>
                    </div>
                    <div id="ts-log-list" style="flex:1; overflow-y:auto; font-family:monospace; font-size:12px; padding:8px;">
                        ${this.renderLogs(e)}
                    </div>
                </div>
            </div>
        `,document.body.appendChild(this.modal),this.bindEvents()}renderLogs(e,t="all"){const a=t==="all"?e:e.filter(s=>s.level===t);return a.length===0?'<div style="color:var(--c-text-muted); text-align:center; padding:24px;">No logs to display</div>':a.map(s=>{const n={debug:"var(--c-text-muted)",info:"var(--c-accent)",warn:"#f59e0b",error:"#ef4444"}[s.level]||"inherit",o=s.data?` ${JSON.stringify(s.data)}`:"";return`
                <div style="padding:4px 8px; border-bottom:1px solid var(--c-border-light); display:flex; gap:8px;">
                    <span style="color:var(--c-text-muted); min-width:180px;">${s.timestamp}</span>
                    <span style="color:${n}; font-weight:600; min-width:50px; text-transform:uppercase;">${s.level}</span>
                    <span style="flex:1; word-break:break-word;">${this.escapeHtml(s.message)}${o?`<span style="color:var(--c-text-muted)">${this.escapeHtml(o)}</span>`:""}</span>
                </div>
            `}).join("")}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}bindEvents(){var t,a,s,i;if(!this.modal)return;(t=this.modal.querySelector(".ts-modal-close"))==null||t.addEventListener("click",()=>this.hide()),this.modal.addEventListener("click",n=>{n.target.classList.contains("ts-modal-overlay")&&this.hide()});const e=this.modal.querySelector("#ts-log-filter");e==null||e.addEventListener("change",()=>{var r,l;const n=(r=this.modal)==null?void 0:r.querySelector("#ts-log-list"),o=(l=this.modal)==null?void 0:l.querySelector("#ts-log-count");if(n){const c=w.getLogHistory(),d=e.value==="all"?c:c.filter(u=>u.level===e.value);n.innerHTML=this.renderLogs(c,e.value),o&&(o.textContent=`${d.length} entries`)}}),(a=this.modal.querySelector("#ts-log-copy"))==null||a.addEventListener("click",()=>{const o=w.getLogHistory().map(r=>`[${r.timestamp}] [${r.level.toUpperCase()}] ${r.message}${r.data?" "+JSON.stringify(r.data):""}`).join(`
`);navigator.clipboard.writeText(o).then(()=>{var l;const r=(l=this.modal)==null?void 0:l.querySelector("#ts-log-copy");if(r){const c=r.innerHTML;r.innerHTML='<i class="bi bi-check"></i> Copied!',setTimeout(()=>{r.innerHTML=c},2e3)}})}),(s=this.modal.querySelector("#ts-log-download"))==null||s.addEventListener("click",()=>{const n=w.getLogHistory(),o=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),r=URL.createObjectURL(o),l=document.createElement("a");l.href=r,l.download=`datatables-viewer-logs-${new Date().toISOString().slice(0,10)}.json`,l.click(),URL.revokeObjectURL(r)}),(i=this.modal.querySelector("#ts-log-clear"))==null||i.addEventListener("click",()=>{var r,l;w.clearHistory();const n=(r=this.modal)==null?void 0:r.querySelector("#ts-log-list"),o=(l=this.modal)==null?void 0:l.querySelector("#ts-log-count");n&&(n.innerHTML=this.renderLogs([])),o&&(o.textContent="0 entries")})}hide(){this.modal&&(this.modal.remove(),this.modal=null)}}const O=class O{constructor(){m(this,"listeners",new Map);m(this,"wildcardListeners",new Set);m(this,"eventHistory",[]);m(this,"maxHistorySize",100);m(this,"debug",!1);typeof localStorage<"u"&&(this.debug=localStorage.getItem("DATATABLE_DEBUG")==="true")}static getInstance(){return O.instance||(O.instance=new O),O.instance}on(e,t){var s;this.listeners.has(e)||this.listeners.set(e,new Set);const a={callback:t,once:!1};return(s=this.listeners.get(e))==null||s.add(a),()=>{var i;(i=this.listeners.get(e))==null||i.delete(a)}}once(e,t){var s;this.listeners.has(e)||this.listeners.set(e,new Set);const a={callback:t,once:!0};return(s=this.listeners.get(e))==null||s.add(a),()=>{var i;(i=this.listeners.get(e))==null||i.delete(a)}}off(e,t){if(!t){this.listeners.delete(e);return}const a=this.listeners.get(e);if(a){for(const s of a)if(s.callback===t){a.delete(s);break}}}onAny(e){return this.wildcardListeners.add(e),()=>{this.wildcardListeners.delete(e)}}emit(e,t){this.debug&&w.debug(`[EventBus] ${e}`,t),this.eventHistory.push({event:e,data:t,timestamp:Date.now()}),this.eventHistory.length>this.maxHistorySize&&this.eventHistory.shift();const a=this.listeners.get(e);if(a){const s=[];for(const i of a)try{i.callback(t),i.once&&s.push(i)}catch(n){w.error(`[EventBus] Error in listener for ${e}`,n)}for(const i of s)a.delete(i)}for(const s of this.wildcardListeners)try{s(e,t)}catch(i){w.error("[EventBus] Error in wildcard listener",i)}if(this.listeners.has("*")){const s=this.listeners.get("*");if(s){const i={event:e,data:t};for(const n of s)n.callback(i)}}}getHistory(){return[...this.eventHistory]}clearHistory(){this.eventHistory=[]}setDebug(e){this.debug=e,typeof localStorage<"u"&&localStorage.setItem("DATATABLE_DEBUG",e?"true":"false")}listenerCount(e){var t;return((t=this.listeners.get(e))==null?void 0:t.size)??0}clear(e){e?this.listeners.delete(e):(this.listeners.clear(),this.wildcardListeners.clear())}};m(O,"instance");let Q=O;const F=Q.getInstance(),H=class H{constructor(){m(this,"defaults",{format:"csv",filename:"export",includeHeaders:!0,delimiter:",",lineEnding:"unix",jsonPretty:!1,chunkSize:1e3})}static getInstance(){return H.instance||(H.instance=new H),H.instance}async export(e,t){const a=Date.now(),s={...this.defaults,...t};F.emit("export:started",{format:s.format,rowCount:e.length});try{const i=s.columns||this.inferColumns(e);let n,o,r;switch(s.format){case"csv":n=this.toCSV(e,i,s),o="text/csv;charset=utf-8",r="csv";break;case"tsv":n=this.toCSV(e,i,{...s,delimiter:"	"}),o="text/tab-separated-values;charset=utf-8",r="tsv";break;case"json":n=this.toJSON(e,i,s),o="application/json;charset=utf-8",r="json";break;case"json-lines":n=this.toJSONLines(e,i,s),o="application/x-ndjson;charset=utf-8",r="jsonl";break;case"xlsx":console.warn("XLSX export not yet implemented, falling back to CSV"),n=this.toCSV(e,i,s),o="text/csv;charset=utf-8",r="csv";break;default:throw new Error(`Unsupported export format: ${s.format}`)}const l=`${s.filename}.${r}`;this.downloadFile(n,l,o);const c={success:!0,filename:l,format:s.format,rowCount:e.length,byteSize:new Blob([n]).size,duration:Date.now()-a};return F.emit("export:completed",c),c}catch(i){const n={success:!1,filename:s.filename,format:s.format,rowCount:0,byteSize:0,duration:Date.now()-a,error:i.message||String(i)};return F.emit("export:failed",{...n,error:n.error}),n}}async toClipboard(e,t){const a={format:"tsv",includeHeaders:!0,...t};try{const s=a.columns||this.inferColumns(e),i=this.toCSV(e,s,{...this.defaults,...a,delimiter:"	"});return await navigator.clipboard.writeText(i),F.emit("export:clipboard",{rowCount:e.length}),!0}catch(s){return console.error("Failed to copy to clipboard:",s),!1}}getExtension(e){return{csv:"csv",tsv:"tsv",json:"json","json-lines":"jsonl",xlsx:"xlsx"}[e]||"txt"}getMimeType(e){return{csv:"text/csv",tsv:"text/tab-separated-values",json:"application/json","json-lines":"application/x-ndjson",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}[e]||"text/plain"}toCSV(e,t,a){const s=[],i=a.lineEnding==="windows"?`\r
`:`
`,n=a.delimiter;a.includeHeaders&&s.push(t.map(o=>this.escapeCSV(o.header,n)).join(n));for(let o=0;o<e.length;o++){const r=e[o],l=t.map(c=>{let d=r[c.key];return c.transform&&(d=c.transform(d,r)),this.escapeCSV(this.formatValue(d),n)});if(s.push(l.join(n)),a.chunkSize&&o>0&&o%a.chunkSize===0){const c=o/e.length*100;F.emit("export:progress",{progress:c,processed:o,total:e.length})}}return s.join(i)}toJSON(e,t,a){const s=e.map(i=>{const n={};return t.forEach(o=>{let r=i[o.key];o.transform&&(r=o.transform(r,i)),n[o.key]=r}),n});return a.jsonPretty?JSON.stringify(s,null,2):JSON.stringify(s)}toJSONLines(e,t,a){const s=a.lineEnding==="windows"?`\r
`:`
`;return e.map(i=>{const n={};return t.forEach(o=>{let r=i[o.key];o.transform&&(r=o.transform(r,i)),n[o.key]=r}),JSON.stringify(n)}).join(s)}inferColumns(e){if(e.length===0)return[];const t=new Set;return e.forEach(a=>{Object.keys(a).forEach(s=>t.add(s))}),Array.from(t).map(a=>({key:a,header:a.replace(/_/g," ").replace(/\b\w/g,s=>s.toUpperCase())}))}escapeCSV(e,t){return e.includes('"')||e.includes(t)||e.includes(`
`)||e.includes("\r")?`"${e.replace(/"/g,'""')}"`:e}formatValue(e){return e==null?"":typeof e=="object"?JSON.stringify(e):String(e)}downloadFile(e,t,a){const s=new Blob([e],{type:a}),i=URL.createObjectURL(s),n=document.createElement("a");n.href=i,n.download=t,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(i)}};m(H,"instance");let Z=H;const Te=Z.getInstance(),j=class j{constructor(){m(this,"shortcuts",new Map);m(this,"keyMap",new Map);m(this,"enabled",!0);this.bindGlobalHandler()}static getInstance(){return j.instance||(j.instance=new j),j.instance}register(e){const t=this.normalizeKeys(e.keys);this.keyMap.has(t)&&console.warn(`Shortcut conflict: ${e.keys} is already registered for ${this.keyMap.get(t)}`),this.shortcuts.set(e.id,{...e,enabled:e.enabled!==!1,preventDefault:e.preventDefault!==!1}),this.keyMap.set(t,e.id)}unregister(e){const t=this.shortcuts.get(e);if(t){const a=this.normalizeKeys(t.keys);this.keyMap.delete(a),this.shortcuts.delete(e)}}setEnabled(e,t){const a=this.shortcuts.get(e);a&&(a.enabled=t)}setGlobalEnabled(e){this.enabled=e}getShortcuts(){return Array.from(this.shortcuts.values())}getShortcutsByCategory(e){return this.getShortcuts().filter(t=>t.category===e)}showHelp(){F.emit("modal:opened",{type:"keyboard-help"});const e=this.renderHelpContent();document.dispatchEvent(new CustomEvent("keyboard-help",{detail:{content:e}}))}hideHelp(){F.emit("modal:closed",{type:"keyboard-help"})}bindGlobalHandler(){document.addEventListener("keydown",e=>{if(!this.enabled||this.isInputElement(e.target)&&e.key!=="Escape")return;const t=this.eventToNormalizedKey(e),a=this.keyMap.get(t);if(a){const s=this.shortcuts.get(a);if(s&&s.enabled){s.preventDefault&&e.preventDefault();try{s.handler(e)}catch(i){console.error(`Error in shortcut handler ${a}:`,i)}}}})}isInputElement(e){const t=e.tagName.toLowerCase();return t==="input"||t==="textarea"||t==="select"||e.contentEditable==="true"}normalizeKeys(e){const t=e.toLowerCase().split("+").map(i=>i.trim()),a=[];(t.includes("ctrl")||t.includes("control"))&&a.push("ctrl"),t.includes("alt")&&a.push("alt"),t.includes("shift")&&a.push("shift"),(t.includes("meta")||t.includes("cmd")||t.includes("command"))&&a.push("meta");const s=t.find(i=>!["ctrl","control","alt","shift","meta","cmd","command"].includes(i));return s&&a.push(s),a.join("+")}eventToNormalizedKey(e){const t=[];e.ctrlKey&&t.push("ctrl"),e.altKey&&t.push("alt"),e.shiftKey&&t.push("shift"),e.metaKey&&t.push("meta");let a=e.key.toLowerCase();return a===" "&&(a="space"),a==="arrowup"&&(a="up"),a==="arrowdown"&&(a="down"),a==="arrowleft"&&(a="left"),a==="arrowright"&&(a="right"),["control","alt","shift","meta"].includes(a)||t.push(a),t.join("+")}renderHelpContent(){const e={navigation:{title:"Navigation",icon:"bi-compass"},selection:{title:"Selection",icon:"bi-check2-square"},actions:{title:"Actions",icon:"bi-lightning"},filters:{title:"Filters",icon:"bi-funnel"},general:{title:"General",icon:"bi-gear"}};let t='<div class="keyboard-help">';for(const[a,s]of Object.entries(e)){const i=this.getShortcutsByCategory(a);if(i.length!==0){t+=`
                <div class="keyboard-help-category">
                    <h3><i class="${s.icon}"></i> ${s.title}</h3>
                    <div class="keyboard-help-list">
            `;for(const n of i){const o=this.formatKeysForDisplay(n.keys);t+=`
                    <div class="keyboard-help-item">
                        <span class="keyboard-help-desc">${n.description}</span>
                        <span class="keyboard-help-keys">${o}</span>
                    </div>
                `}t+="</div></div>"}}return t+="</div>",t}formatKeysForDisplay(e){return e.split("+").map(t=>`<kbd>${t.charAt(0).toUpperCase()+t.slice(1)}</kbd>`).join(" + ")}};m(j,"instance");let V=j;function Me(b){const e=V.getInstance();e.register({id:"help",keys:"?",description:"Show keyboard shortcuts",category:"general",handler:()=>e.showHelp()}),e.register({id:"close-modal",keys:"Escape",description:"Close modal / Clear selection",category:"general",handler:()=>{var a;const t=document.querySelector(".ts-modal-overlay.show");if(t){t.classList.remove("show");return}(a=b.onClearSelection)==null||a.call(b)}}),b.onSearch&&(e.register({id:"search",keys:"Ctrl+F",description:"Focus search box",category:"filters",handler:b.onSearch}),e.register({id:"search-alt",keys:"/",description:"Focus search box",category:"filters",handler:b.onSearch})),b.onExport&&e.register({id:"export",keys:"Ctrl+E",description:"Export data",category:"actions",handler:b.onExport}),b.onRefresh&&e.register({id:"refresh",keys:"Ctrl+R",description:"Refresh data",category:"actions",handler:b.onRefresh,preventDefault:!0}),b.onReset&&e.register({id:"reset",keys:"Ctrl+Shift+R",description:"Reset all filters",category:"actions",handler:b.onReset,preventDefault:!0}),b.onShowSchema&&e.register({id:"schema",keys:"Ctrl+I",description:"Show database schema",category:"actions",handler:b.onShowSchema}),b.onSelectAll&&e.register({id:"select-all",keys:"Ctrl+A",description:"Select all rows",category:"selection",handler:b.onSelectAll}),b.onClearSelection&&e.register({id:"clear-selection",keys:"Ctrl+D",description:"Clear selection",category:"selection",handler:b.onClearSelection}),b.onNextPage&&e.register({id:"next-page",keys:"Ctrl+Right",description:"Next page",category:"navigation",handler:b.onNextPage}),b.onPrevPage&&e.register({id:"prev-page",keys:"Ctrl+Left",description:"Previous page",category:"navigation",handler:b.onPrevPage}),b.onFirstPage&&e.register({id:"first-page",keys:"Ctrl+Home",description:"First page",category:"navigation",handler:b.onFirstPage}),b.onLastPage&&e.register({id:"last-page",keys:"Ctrl+End",description:"Last page",category:"navigation",handler:b.onLastPage}),b.onToggleTheme&&e.register({id:"toggle-theme",keys:"Ctrl+Shift+T",description:"Toggle dark/light theme",category:"general",handler:b.onToggleTheme})}V.getInstance();class Le{constructor(e){m(this,"container");m(this,"configManager");m(this,"client");m(this,"stateManager");m(this,"categoryManager",null);m(this,"sidebar");m(this,"toolbar");m(this,"grid");m(this,"schemaViewer");m(this,"statsViewer");m(this,"logViewer",new ke);m(this,"theme","light");m(this,"density","normal");m(this,"dom",{});m(this,"columnSchemas",{});m(this,"configSource","fallback");if(!e.container)throw new Error("Container required");this.container=e.container,this.client=e.client||new Y,this.stateManager=new ye,this.stateManager.subscribe(this.onStateChange.bind(this));const t=localStorage.getItem("ts-theme"),a=localStorage.getItem("ts-density");t&&(this.theme=t),a&&(this.density=a)}async init(){try{const e=await fetch("config/index.json");if(!e.ok)throw new Error("Failed to load app configuration");const t=await e.json();this.configManager=new be(t),this.client=new Y({serviceUrls:this.configManager.getServiceUrls()});const a=this.configManager.getGlobalSettings();this.stateManager.update({pageSize:a.pageSize||50,showRowNumbers:a.showRowNumbers!==!1}),this.loadStateFromUrl(),this.renderLayout(),this.initComponents(),this.updateConfigSourceIndicator(),await new Promise(s=>{requestAnimationFrame(()=>{this.handleInitialLoad(a).then(s)})})}catch(e){this.container.innerHTML=`<div class="ts-alert ts-alert-danger"><i class="bi bi-x-circle-fill"></i> ${e.message}</div>`}}async handleInitialLoad(e){const t=e.defaultSource,a=new URLSearchParams(window.location.search),s=a.get("upa")||a.get("ref")||a.get("object")||a.get("db");let i={};try{const l=await fetch("app-config.json");l.ok?(i=await l.json(),w.info("[TableRenderer] Loaded app-config.json successfully",{upa:i.upa})):w.warn(`[TableRenderer] app-config.json not found: ${l.status} ${l.statusText}`)}catch(l){w.warn("[TableRenderer] Error loading app-config.json:",l)}const n=i.upa,o=i.token;o&&(this.sidebar.setToken(o),this.client.setToken(o));let r=null;s?(r=s,this.configSource="kbase_workspace",w.info("[TableRenderer] Using URL parameter for data source:",s)):n?(r=n,this.configSource="app_config",w.info("[TableRenderer] Using app-config.json for data source:",n)):t?(r=t,this.configSource="default",w.warn("[TableRenderer] Using defaultSource (dev/fallback data):",t)):(this.configSource="fallback",w.warn("[TableRenderer] No data source found, app will wait for user input")),this.updateConfigSourceIndicator(),r&&this.sidebar.setBerdlId(r),r&&(await this.configManager.initialize(r,this.client),await this.loadObject(r))}async loadObject(e){const t=this.sidebar.getToken(),a=e||this.sidebar.getBerdlId();if(!a||a.trim()===""){this.showAlert("Object ID or database name is required","danger");return}const s=a.trim();this.client.setToken(t||""),this.stateManager.update({berdlTableId:s,loading:!0,error:null});try{await this.configManager.initialize(s,this.client);const i=await this.client.listDatabases(s),n=i.databases||[],o=i.has_multiple_databases||n.length>1;if(n.length===0&&i.tables&&i.tables.length>0){const c={db_name:s,db_display_name:`Database (${s})`,tables:i.tables,row_count:i.total_rows||null,schemas:i.schemas||null};n.push(c)}if(n.length===0)throw new Error(`No tables or databases found in "${s}"`);this.sidebar.updateDatabases(n),this.stateManager.update({availableDatabases:n,activeDatabase:n[0].db_name});const r=n[0],l=r.tables||[];if(this.stateManager.update({availableTables:l}),this.sidebar.updateTables(l),l.length>0){const c=l[0].name;await this.switchTable(c);const d=o?`Loaded object "${s}" - ${n.length} databases found`:`Loaded database "${s}" - ${l.length} tables found`;this.showAlert(d,"success")}else this.showAlert(`No tables found in database "${r.db_name}"`,"warning")}catch(i){this.showAlert(`Failed to load database "${s}": ${i.message}`,"danger"),this.stateManager.update({availableTables:[],activeTableName:null,loading:!1,error:i.message}),this.sidebar.updateTables([])}finally{this.stateManager.update({loading:!1})}}renderLayout(){this.container.innerHTML=`
            <div class="ts-app" data-theme="${this.theme}" data-density="${this.density}">
                <aside class="ts-sidebar" id="ts-sidebar-container"></aside>
                <main class="ts-main">
                    <header class="ts-toolbar" id="ts-toolbar-container"></header>
                    <div id="ts-alert"></div>

                    <div class="ts-grid-header" id="ts-grid-header" style="display:none">
                        <div class="ts-grid-header-content">
                            <div class="ts-db-info">
                                <i class="bi bi-database"></i>
                                <span id="ts-db-name">Database</span>
                            </div>
                            <div class="ts-table-info">
                                <i class="bi bi-table"></i>
                                <span id="ts-active-table-name">Table</span>
                            </div>
                        </div>
                    </div>
                    <div class="ts-grid-wrapper" style="position:relative">
                        <div class="ts-loading-overlay" id="ts-loading-overlay" style="display:none">
                            <div class="ts-loading-spinner-wrapper">
                                <span class="ts-spinner" style="width:32px;height:32px"></span>
                                <span class="ts-loading-text" style="margin-top:12px;font-size:13px;color:var(--c-text-secondary)">Loading...</span>
                            </div>
                        </div>
                        <div class="ts-grid" id="ts-grid-container"></div>
                    </div>
                    <footer class="ts-footer">
                        <div class="ts-status" id="ts-status">Ready</div>
                        <div class="ts-config-source" id="ts-config-source" title="Configuration source"></div>
                        <div class="ts-table-name" id="ts-table-name"></div>
                        <div class="ts-pager" id="ts-pager"></div>
                    </footer>
                </main>
                
                <div class="ts-settings-popup" id="ts-settings-popup" style="top: 70px; right: 24px; bottom: auto;">
                    <div class="ts-settings-header">Settings</div>
                     <div class="ts-settings-body">
                        <div class="ts-settings-row">
                            <div class="ts-settings-label"><i class="bi bi-moon-stars"></i> Theme</div>
                            <div class="ts-switch ${this.theme==="dark"?"on":""}" id="ts-theme-toggle"></div>
                        </div>
                        <div class="ts-settings-row">
                            <div class="ts-settings-label"><i class="bi bi-arrows-angle-expand"></i> Density</div>
                            <div class="ts-density-options">
                                <button class="ts-density-opt ${this.density==="compact"?"active":""}" data-density="compact" title="Compact"><i class="bi bi-list"></i></button>
                                <button class="ts-density-opt ${this.density==="normal"?"active":""}" data-density="normal" title="Normal"><i class="bi bi-list-ul"></i></button>
                                <button class="ts-density-opt ${this.density==="comfortable"?"active":""}" data-density="comfortable" title="Comfortable"><i class="bi bi-card-heading"></i></button>
                            </div>
                        </div>
                        <div class="ts-settings-row" style="margin-top:8px; padding-top:8px; border-top:1px solid var(--c-border);">
                            <button class="ts-btn-secondary" id="ts-view-logs" style="width:100%;">
                                <i class="bi bi-terminal"></i> View System Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `,this.dom.status=this.container.querySelector("#ts-status"),this.dom.pager=this.container.querySelector("#ts-pager"),this.dom.alert=this.container.querySelector("#ts-alert"),this.dom.tableName=this.container.querySelector("#ts-table-name"),this.dom.loadingOverlay=this.container.querySelector("#ts-loading-overlay")}initComponents(){this.sidebar=new we({container:this.container.querySelector("#ts-sidebar-container"),configManager:this.configManager,stateManager:this.stateManager,onApiChange:()=>{},onLoadData:()=>this.handleLoadData(),onTableChange:n=>this.switchTable(n),onDatabaseChange:n=>this.handleDatabaseChange(n),onExport:()=>this.exportCsv(),onReset:()=>this.reset(),onShowSchema:n=>this.showDatabaseSchema(n),onShowStats:n=>this.showColumnStatistics(n),onColumnVisibilityChange:n=>{const o=new Set;n.forEach(r=>{r.visible&&o.add(r.column)}),this.stateManager.update({visibleColumns:o})}}),this.sidebar.mount(),this.toolbar=new xe({container:this.container.querySelector("#ts-toolbar-container"),onSearch:n=>{const o=n?n.trim():"";this.stateManager.update({searchValue:o})},onRefresh:()=>this.softRefresh(),onTestConnection:async()=>{this.stateManager.update({loading:!0});try{const n=await this.client.testConnection();this.showAlert(`Connection Successful! Service Status: ${n.status}`,"success")}catch(n){this.showAlert(`Connection Failed: ${n.message}`,"danger")}finally{this.stateManager.update({loading:!1})}},onSearchNext:()=>{this.grid&&(this.grid.navigateToNextMatch(),this.toolbar.updateSearchNav())},onSearchPrev:()=>{this.grid&&(this.grid.navigateToPreviousMatch(),this.toolbar.updateSearchNav())},getSearchMatchInfo:()=>this.grid?this.grid.getSearchMatchInfo():{current:0,total:0},onShare:()=>this.copyShareableUrl(),kbaseMode:this.configSource==="kbase_workspace"}),this.toolbar.mount(),this.initKeyboardShortcuts();const e=this.toolbar.getSettingsButton();e&&e.addEventListener("click",n=>{n.stopPropagation();const o=this.container.querySelector("#ts-settings-popup");o==null||o.classList.toggle("show")});const t=this.container.querySelector("#ts-theme-toggle"),a=this.container.querySelectorAll(".ts-density-opt"),s=this.container.querySelector(".ts-app");t==null||t.addEventListener("click",()=>{this.toggleTheme(),t.classList.toggle("on",this.theme==="dark")}),a.forEach(n=>{n.addEventListener("click",()=>{this.density=n.dataset.density,s==null||s.setAttribute("data-density",this.density),a.forEach(o=>o.classList.remove("active")),n.classList.add("active"),localStorage.setItem("ts-density",this.density)})});const i=this.container.querySelector("#ts-view-logs");i==null||i.addEventListener("click",()=>{this.logViewer.show()}),this.grid=new Se({container:this.container.querySelector("#ts-grid-container"),stateManager:this.stateManager,onSort:(n,o)=>{this.stateManager.update({sortColumn:n,sortOrder:o,currentPage:0}),this.fetchData()},onFilter:async(n,o)=>{const r=this.stateManager.getState();if(!r.activeTableName)return;const{parseFilterInput:l,normalizeColumnType:c}=await oe(async()=>{const{parseFilterInput:g,normalizeColumnType:f}=await import("./filter-parser-HXU3E1Qm.js");return{parseFilterInput:g,normalizeColumnType:f}},[],import.meta.url),d=c(this.getColumnType(r.activeTableName,n)),u=l(o,d);if(u&&o.trim()){const g=r.advancedFilters||[],f=g.findIndex(p=>p.column===n);f>=0?g[f]={column:n,operator:u.operator,value:u.value,value2:u.value2}:g.push({column:n,operator:u.operator,value:u.value,value2:u.value2});const y={...r.columnFilters};y[n]=o,this.stateManager.update({columnFilters:y,advancedFilters:g.length>0?g:void 0,currentPage:0}),this.sidebar.renderFilterChips()}else{const g={...r.columnFilters};delete g[n];const f=(r.advancedFilters||[]).filter(y=>y.column!==n);this.stateManager.update({columnFilters:g,advancedFilters:f.length>0?f:void 0,currentPage:0}),this.sidebar.renderFilterChips()}this.fetchData()},getColumnType:n=>{const o=this.stateManager.getState();return o.activeTableName?this.getColumnType(o.activeTableName,n):"TEXT"},onRowSelect:()=>this.updateSelectionStatus()}),this.grid.mount(),this.schemaViewer=new Ce({configManager:this.configManager,stateManager:this.stateManager,client:this.client,createModal:this.createModal.bind(this),switchTable:this.switchTable.bind(this),fetchData:this.fetchData.bind(this),getSchemaForTable:async n=>(await this.loadTableSchema(n),this.getSchemaColumns(n)),getConfigColumns:n=>{const o=this.configManager.getTableConfig(n);return(o==null?void 0:o.columns)||[]},getStateColumns:()=>this.stateManager.getState().columns}),this.statsViewer=new $e({stateManager:this.stateManager,client:this.client,createModal:this.createModal.bind(this),showAlert:this.showAlert.bind(this)})}handleLoadData(){const e=this.stateManager.getState();if(!e.berdlTableId||e.availableTables.length===0){const t=this.sidebar.getBerdlId();this.loadObject(t);return}this.fetchData()}initKeyboardShortcuts(){Me({onSearch:()=>this.toolbar.focusSearch(),onExport:()=>this.exportCsv(),onRefresh:()=>this.softRefresh(),onReset:()=>this.reset(),onSelectAll:()=>this.grid.selectAll(),onClearSelection:()=>this.grid.clearSelection(),onToggleTheme:()=>this.toggleTheme(),onShowSchema:()=>{const e=this.stateManager.getState();e.activeTableName&&this.showDatabaseSchema(e.activeTableName)},onNextPage:()=>this.nextPage(),onPrevPage:()=>this.prevPage(),onFirstPage:()=>this.goToPage(0),onLastPage:()=>{const e=this.stateManager.getState(),t=Math.ceil(e.totalCount/e.pageSize);this.goToPage(t-1)}})}async handleDatabaseChange(e){const t=this.stateManager.getState();if(!t.berdlTableId){this.showAlert("No object loaded","warning");return}this.stateManager.update({activeDatabase:e,loading:!0,error:null,activeTableName:null,availableTables:[]});try{const s=(await this.client.listTablesInDatabase(t.berdlTableId,e)).tables||[];if(s.length===0){this.showAlert(`No tables found in database "${e}"`,"warning"),this.stateManager.update({loading:!1});return}this.stateManager.update({availableTables:s}),this.sidebar.updateTables(s),this.sidebar.setActiveDatabase(e);const i=s[0].name;await this.switchTable(i),this.showAlert(`Switched to database "${e}" - ${s.length} table(s)`,"success")}catch(a){this.showAlert(`Failed to load database "${e}": ${a.message}`,"danger"),this.stateManager.update({loading:!1,error:a.message})}}async switchTable(e){this.stateManager.update({activeTableName:e});const t=this.configManager.getTableConfig(e);if(!t){w.error(`[TableRenderer] Config not found for table: ${e}`);return}this.categoryManager=new ve(t),this.sidebar.setCategoryManager(this.categoryManager),this.sidebar.updateTableInfo(e),this.stateManager.update({currentPage:0,sortColumn:null,columnFilters:{},searchValue:"",data:[],headers:[],columns:[]}),this.toolbar.setSearch(""),this.grid.clearSelection(),this.loadTableDependencies(e).then(()=>{const a=this.stateManager.getState();a.activeTableName===e&&this.stateManager.update({data:[...a.data]})}),await this.fetchData()}async loadTableDependencies(e){var s;const t=this.configManager.getTableConfig(e);if(!t)return;const a=t.columns||[];for(const i of a){if(!i.transform)continue;const n=Array.isArray(i.transform)?i.transform:[i.transform];for(const o of n)if(o.type==="ontology"&&((s=o.options)!=null&&s.lookupTable)){const r=o.options.lookupTable,l=o.options.lookupKey||"id",c=o.options.lookupValue||"name";try{const d=this.stateManager.getState();if(!d.berdlTableId)continue;const u=await this.client.getTableData({berdl_table_id:d.berdlTableId,table_name:r,limit:1e4,offset:0}),g={},f=u.headers,y=f.indexOf(l),p=f.indexOf(c);y!==-1&&p!==-1&&(u.data.forEach(v=>{const S=String(v[y]),C=String(v[p]);g[S]=C}),N.preLoadOntology(g,o.options.ontologyType||"custom"))}catch(d){console.warn(`Failed to load dependency table ${r}`,d)}}}}async fetchData(){var t;const e=this.stateManager.getState();if(!(!e.activeTableName||!e.berdlTableId)){this.stateManager.update({loading:!0});try{const a={},s=new Set(((t=e.advancedFilters)==null?void 0:t.map(r=>r.column))||[]);for(const[r,l]of Object.entries(e.columnFilters))!s.has(r)&&l!==void 0&&l!==null&&l!==""&&(a[r]=l);let i;e.activeDatabase&&!e.aggregations&&!e.groupBy?i=await this.client.getTableDataFromDatabase(e.berdlTableId,e.activeDatabase,{table_name:e.activeTableName,limit:e.pageSize,offset:e.currentPage*e.pageSize,sort_column:e.sortColumn||void 0,sort_order:e.sortOrder==="asc"?"ASC":"DESC",search_value:e.searchValue||void 0}):i=await this.client.getTableData({berdl_table_id:e.berdlTableId,table_name:e.activeTableName,limit:e.pageSize,offset:e.currentPage*e.pageSize,sort_column:e.sortColumn||void 0,sort_order:e.sortOrder==="asc"?"ASC":"DESC",col_filter:Object.keys(a).length>0?a:void 0,filters:e.advancedFilters,aggregations:e.aggregations,group_by:e.groupBy}),this.processColumns(i.headers,e.activeTableName);const n=e.activeTableName;i.column_schema&&i.column_schema.length>0&&n?(this.columnSchemas[n]||(this.columnSchemas[n]={}),(i.column_schema||[]).forEach(l=>{this.columnSchemas[n][l.name]={type:l.type,notnull:l.notnull,pk:l.pk}})):e.activeTableName&&await this.loadTableSchema(e.activeTableName);let o=(i.data||[]).map(r=>{const l={};return i.headers.forEach((c,d)=>{l[c]=r[d]}),l});e.sortColumn&&o.length>0&&(o=this.sortWithNullsLast(o,e.sortColumn,e.sortOrder||"asc")),this.stateManager.update({headers:i.headers,data:o,totalCount:i.total_count||0,queryCached:i.cached||!1,queryTime:i.execution_time_ms}),this.toolbar&&this.grid&&requestAnimationFrame(()=>{setTimeout(()=>{this.toolbar.updateSearchNav()},50)})}catch(a){const s=(a==null?void 0:a.message)||"Failed to load table data";w.error("Failed to fetch table data",a),this.showAlert(s,"danger"),this.stateManager.update({data:[],headers:[],columns:[],error:s})}finally{this.stateManager.update({loading:!1})}}}processColumns(e,t){const a=this.configManager.getTableConfig(t),s=(a==null?void 0:a.columns)||[],i=[],n=new Set;s.forEach(r=>{i.push({...r,dataType:r.dataType||"string",align:r.align||"left",searchable:r.searchable!==!1,copyable:r.copyable!==!1,visible:r.visible!==!1,sortable:r.sortable!==!1,filterable:r.filterable!==!1,width:r.width||"auto",categories:r.categories||[]}),n.add(r.column)});const o=r=>{const l=r.toLowerCase(),c=[];return(l.match(/^(id|name|display_name|label)$/)||l.endsWith("_id")||l.endsWith("_name")||l.includes("locus")||l.includes("symbol")||l.includes("alias")||l.includes("contig"))&&c.push("core"),(l.includes("function")||l.includes("product")||l.includes("annotation")||l.includes("subsystem")||l.includes("class")||l.includes("reaction")||l.includes("ec")||l.includes("cog")||l.includes("pfam")||l.includes("tigrfam")||l.includes("go")||l.includes("kegg")||l.includes("note")||l.includes("inference")||l.includes("type"))&&c.push("functional"),(l.includes("uniprot")||l.includes("xref")||l.includes("reference")||l.includes("link")||l.includes("url")||l.includes("dbxref"))&&c.push("external"),(l.includes("sequence")||l.includes("start")||l.includes("stop")||l.includes("length")||l.includes("strand")||l.includes("protein_length")||l.includes("molecular_weight")||l.includes("isoelectric"))&&c.push("sequence"),(l.match(/^(deleted|row_hash|last_synced|created_at|updated_at|sync_.*)$/)||l.includes("hash")||l.includes("sync"))&&c.push("metadata"),(l.match(/^(error|status|report|message|valid|significance)$/)||l.includes("error")||l.includes("valid"))&&c.push("status"),c.length===0&&(l.match(/^[a-z_]*id$/i)||l.endsWith("_id")?c.push("core"):c.push("functional")),c};if(e.forEach(r=>{n.has(r)||i.push({column:r,displayName:r.replace(/_/g," "),dataType:"string",align:"left",searchable:!0,copyable:!0,visible:!0,sortable:!0,filterable:!0,width:"auto",categories:o(r)})}),this.stateManager.update({columns:i}),this.categoryManager){this.categoryManager.setColumns(i);const r=this.stateManager.getState();if(r.visibleColumns.size===0)this.stateManager.update({visibleColumns:this.categoryManager.getInitialVisibleColumns()});else{const l=new Set(r.visibleColumns),c=new Set(i.map(d=>d.column));l.forEach(d=>{c.has(d)||l.delete(d)}),this.stateManager.update({visibleColumns:l})}}}async loadTableSchema(e){if(!(!e||this.columnSchemas[e]))try{const t=this.stateManager.getState();if(!t.berdlTableId)return;let a=[];try{a=await this.client.getTableSchema(t.berdlTableId,e)}catch(s){w.warn("[TableRenderer] Failed to load schema from ApiClient",s)}a.length>0&&(this.columnSchemas[e]={},a.forEach(s=>{this.columnSchemas[e][s.name]={type:s.type,notnull:!!s.notnull,pk:!!s.pk}}))}catch(t){w.warn("[TableRenderer] Error loading schema:",t)}}getColumnType(e,t){var a,s;return((s=(a=this.columnSchemas[e])==null?void 0:a[t])==null?void 0:s.type)||"TEXT"}getSchemaColumns(e){const t=this.columnSchemas[e];return t?Object.entries(t).map(([a,s])=>({column:a,type:s.type,notnull:s.notnull,pk:s.pk})):[]}softRefresh(){this.fetchData()}reset(){this.grid.clearFilterFocus(),this.stateManager.update({sortColumn:null,sortOrder:"asc",searchValue:"",columnFilters:{},currentPage:0}),this.toolbar.setSearch(""),this.grid.clearSelection(),this.sidebar.renderFilterChips(),this.fetchData()}nextPage(){const e=this.stateManager.getState(),t=Math.ceil(e.totalCount/e.pageSize);e.currentPage<t-1&&this.goToPage(e.currentPage+1)}prevPage(){const e=this.stateManager.getState();e.currentPage>0&&this.goToPage(e.currentPage-1)}goToPage(e){e>=0&&(this.stateManager.update({currentPage:e}),this.fetchData())}toggleTheme(){this.theme=this.theme==="light"?"dark":"light",localStorage.setItem("ts-theme",this.theme);const e=this.container.querySelector(".ts-app");e&&e.setAttribute("data-theme",this.theme)}async exportCsv(){const e=this.stateManager.getState();if(e.data.length===0)return;const t=this.grid.getSelection(),s=t.size>0?e.data.filter((i,n)=>t.has(n)):e.data;await Te.export(s,{format:"csv",filename:`export_${e.activeTableName||"data"}_${new Date().toISOString().split("T")[0]}`,columns:e.columns.filter(i=>e.visibleColumns.has(i.column)).map(i=>({key:i.column,header:i.displayName||i.column})),includeHeaders:!0})}onStateChange(e){this.updateStatusBar(e),this.updatePagination(e),this.updateLoadingOverlay(e),this.syncStateToUrl(),e.error&&this.showAlert(e.error,"danger"),this.toolbar&&this.grid&&setTimeout(()=>{this.toolbar.updateSearchNav()},100)}updateLoadingOverlay(e){if(!this.dom.loadingOverlay)return;e.loading&&e.availableTables.length>0?this.dom.loadingOverlay.style.display="flex":this.dom.loadingOverlay.style.display="none"}updateStatusBar(e){var o,r;if(!this.dom.status)return;let t="";const a=[];if(e.queryCached&&a.push(" Cached"),e.queryTime!==void 0&&a.push(`${e.queryTime}ms`),e.totalCount>0){const l=e.currentPage*e.pageSize+1,c=Math.min((e.currentPage+1)*e.pageSize,e.totalCount),d=Math.ceil(e.totalCount/e.pageSize);t=`<div style="display:flex;flex-direction:column;gap:2px">
                <div style="font-size:13px;font-weight:600;color:var(--c-text-primary)">Rows: <strong>${l.toLocaleString()}</strong>  <strong>${c.toLocaleString()}</strong> of <strong>${e.totalCount.toLocaleString()}</strong></div>
                <div style="font-size:11px;color:var(--c-text-muted);display:flex;gap:8px;align-items:center">
                    <span>Page ${e.currentPage+1} of ${d||1}</span>
                    ${a.length>0?`<span style="display:flex;align-items:center;gap:4px">${a.join("  ")}</span>`:""}
                </div>
            </div>`;const u=((r=(o=this.grid)==null?void 0:o.getSelection())==null?void 0:r.size)||0;u>0&&(t+=`<div style="margin-top:4px;font-size:11px"><span class="ts-selection-info">${u} row${u!==1?"s":""} selected</span></div>`)}else t='<div style="font-size:13px">Ready</div>';this.dom.status.innerHTML=t,this.dom.tableName&&(e.activeTableName?this.dom.tableName.innerHTML=`<span style="color:var(--c-text-muted);font-size:13px;font-weight:500">${e.activeTableName}</span>`:this.dom.tableName.innerHTML="");const s=this.container.querySelector("#ts-grid-header"),i=this.container.querySelector("#ts-db-name"),n=this.container.querySelector("#ts-active-table-name");s&&i&&n&&(e.activeTableName&&e.berdlTableId?(s.style.display="block",i.textContent=e.berdlTableId,n.textContent=e.activeTableName):s.style.display="none")}updateSelectionStatus(){const e=this.stateManager.getState();this.updateStatusBar(e)}updatePagination(e){if(!this.dom.pager)return;const t=Math.ceil(e.totalCount/e.pageSize),a=e.currentPage;this.dom.pager.innerHTML=`
            <button class="ts-page-btn" data-page="${a-1}" ${a<=0?"disabled":""}><i class="bi bi-chevron-left"></i></button>
            <span class="ts-page-info">${a+1} / ${t||1}</span>
            <button class="ts-page-btn" data-page="${a+1}" ${a>=t-1?"disabled":""}><i class="bi bi-chevron-right"></i></button>
        `,this.dom.pager.querySelectorAll(".ts-page-btn").forEach(s=>{s.addEventListener("click",()=>{const i=parseInt(s.dataset.page||"0");i>=0&&i<t&&this.goToPage(i)})})}syncStateToUrl(){w.debug("[TableRenderer] URL sync disabled in KBase mode")}loadStateFromUrl(){w.debug("[TableRenderer] URL state parsing disabled in KBase mode")}async copyShareableUrl(){const e=window.location.href;try{await navigator.clipboard.writeText(e),this.showAlert("Link copied to clipboard!","success")}catch{const t=document.createElement("input");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),this.showAlert("Link copied to clipboard!","success")}}updateConfigSourceIndicator(){const e=this.container.querySelector("#ts-config-source");if(!e)return;const t={kbase_workspace:{text:" KBase",class:"config-kbase"},app_config:{text:" Config",class:"config-app"},default:{text:" Default",class:"config-default"},fallback:{text:" Fallback",class:"config-fallback"}},a=t[this.configSource]||t.fallback;e.textContent=a.text,e.className=`ts-config-source ${a.class}`}getConfigSource(){return this.configSource}showAlert(e,t){if(this.dom.alert){const s=e.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>"),n=t==="danger"?8e3:e.length>100?6e3:4e3;this.dom.alert.innerHTML=`<div class="ts-alert ts-alert-${t}">${s}</div>`,setTimeout(()=>{this.dom.alert&&(this.dom.alert.innerHTML="")},n)}}showDatabaseSchema(e){this.schemaViewer.show(e)}isValueEmpty(e){if(e==null)return!0;if(typeof e=="string"){const t=e.trim();if(t===""||t.length===0||t.toLowerCase()==="null"||t.toLowerCase()==="undefined"||t==="-")return!0}return!!(Array.isArray(e)&&e.length===0||typeof e=="number"&&isNaN(e)||typeof e=="object"&&!Array.isArray(e)&&Object.keys(e).length===0)}sortWithNullsLast(e,t,a){return!e||e.length===0||!t||!e.some(i=>t in i)?e:[...e].sort((i,n)=>{const o=i==null?void 0:i[t],r=n==null?void 0:n[t],l=this.isValueEmpty(o),c=this.isValueEmpty(r);if(l&&c)return 0;if(l)return 1;if(c)return-1;let d=0;if(typeof o==="number"&&typeof r==="number"){if(isNaN(o)&&isNaN(r))return 0;if(isNaN(o))return 1;if(isNaN(r))return-1;d=o-r}else if(o instanceof Date&&r instanceof Date)d=o.getTime()-r.getTime();else{const f=String(o??"").trim().toLowerCase(),y=String(r??"").trim().toLowerCase();f<y?d=-1:f>y?d=1:d=0}return a==="desc"?-d:d})}async handleUploadDb(e){console.warn("Upload not supported in KBase mode",e)}async showColumnStatistics(e){await this.statsViewer.show(e)}createModal(e,t){var n;const a=document.querySelector(".ts-modal-overlay");a&&a.remove();const s=document.createElement("div");s.className="ts-modal-overlay",s.innerHTML=`
            <div class="ts-modal">
                <div class="ts-modal-header">
                    <span class="ts-modal-title">${e}</span>
                    <button class="ts-modal-close"><i class="bi bi-x-lg"></i></button>
                </div>
                <div class="ts-modal-body">${t}</div>
            </div>
        `,document.body.appendChild(s),requestAnimationFrame(()=>s.classList.add("show"));const i=()=>{s.classList.remove("show"),setTimeout(()=>s.remove(),200)};return(n=s.querySelector(".ts-modal-close"))==null||n.addEventListener("click",i),s.addEventListener("click",o=>{o.target===s&&i()}),s}}document.addEventListener("DOMContentLoaded",async()=>{const b=document.querySelector("#app");if(b){const t=new URLSearchParams(window.location.search).get("db");await new Le({container:b}).init(),t&&w.info(`Database parameter detected: ${t}`)}else w.error("App container #app not found")});export{ee as C};
